# üéì TP7 ‚Äî  M√©thodes d'authentification

## Cas 1: M√©thode d'authentification par session

## üéØ Objectifs

- Servir des donn√©es **JSON** et **XML** depuis votre app (m√™me domaine).

- Consommer ces donn√©es c√¥t√© **front** avec `fetch()` (AJAX) pour rafra√Æchir sans recharger la page.

- Mettre en place une **authentification par session** (login/logout) prot√©geant certaines actions (ex. ajout d‚Äôutilisateur).

- Garder **Composer (PSR-4)** et l‚Äôarchitecture propre (Repository JSON/SQLite d√©j√† faits).

> Pr√©-requis : TP6 + TP6 (suite) fonctionnels (autoload PSR-4 actif).

---

## 1) Structure cible

```
tp7-app/ (vous pouvez √©voluer depuis tp6-app)
‚îú‚îÄ‚îÄ composer.json                 (autoload PSR-4 "App\\": "src/")
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îú‚îÄ‚îÄ users.json                (si repo=json)
‚îÇ   ‚îî‚îÄ‚îÄ app.db                    (si repo=sqlite)
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îú‚îÄ‚îÄ index.php                 (UI + fetch AJAX)
‚îÇ   ‚îú‚îÄ‚îÄ login.php                 (formulaire HTML + POST)
‚îÇ   ‚îú‚îÄ‚îÄ logout.php                (d√©connexion)
‚îÇ   ‚îî‚îÄ‚îÄ api.php                   (endpoints JSON/XML s√©curis√©s)
‚îî‚îÄ‚îÄ src/
    ‚îú‚îÄ‚îÄ App.php                   (inchang√© depuis TP6 suite)
    ‚îú‚îÄ‚îÄ Services/
    ‚îÇ   ‚îú‚îÄ‚îÄ SessionManager.php    (existant)
    ‚îÇ   ‚îî‚îÄ‚îÄ AuthService.php       (NOUVEAU)
    ‚îú‚îÄ‚îÄ Interfaces/               (Authentifiable.php, UserRepository.php)
    ‚îú‚îÄ‚îÄ Domain/                   (UserRecord.php)
    ‚îú‚îÄ‚îÄ Core/                     (Utilisateur + Admin/Membre/Visiteur)
    ‚îî‚îÄ‚îÄ Repositories/             (FileUserRepository + SqliteUserRepository)
```

---

## 2) Service d‚Äôauthentification

Cr√©er le fichier **src/Services/AuthService.php** :

```php
<?php
namespace App\Services;

/**
 * AuthService ‚Äî Authentification simple par sessions.
 * - Utilise SessionManager (d√©marrage, set/get, destroy).
 * - D√©mo p√©dagogique : identifiants cod√©s en dur (√† remplacer par une base/LDAP plus tard).
 */
class AuthService
{
    private const USERS = [
        // login => password (hash√©s en prod ! Ici pour d√©mo : clair)
        'admin'  => 'admin123',
        'membre' => 'membre123',
    ];

    /** Retourne true si un utilisateur est connect√© */
    public static function isLogged(): bool
    {
        SessionManager::demarrer();
        return (bool) SessionManager::get('auth_user');
    }

    /** Retourne le login courant ou null */
    public static function currentUser(): ?string
    {
        SessionManager::demarrer();
        return SessionManager::get('auth_user');
    }

    /** Tentative de login : true si OK */
    public static function login(string $login, string $password): bool
    {
        SessionManager::demarrer();

        // ‚ö†Ô∏è D√©mo : check simple (en prod : hash, rate limit, CSRF, etc.)
        if (isset(self::USERS[$login]) && self::USERS[$login] === $password) {
            SessionManager::set('auth_user', $login);
            return true;
        }
        return false;
    }

    /** D√©connexion */
    public static function logout(): void
    {
        SessionManager::demarrer();
        SessionManager::detruire();
    }

    /**
     * Protection d'action : l√®ve une erreur si non connect√©
     * √Ä utiliser c√¥t√© API pour les routes prot√©g√©es.
     */
    public static function requireLogin(): void
    {
        if (!self::isLogged()) {
            http_response_code(401);
            header('Content-Type: application/json; charset=utf-8');
            echo json_encode(['error' => 'auth_required'], JSON_UNESCAPED_UNICODE);
            exit;
        }
    }
}
```

---

## 3) Page d‚Äôaccueil (UI + AJAX)

Cr√©er le fichier **public/index.php** :

> Pour externaliser le css dans un fichier css s√©par√©
> 
> ```css
> <head>
>     <link rel="stylesheet" href="style.css">
> </head>
> ```

```php
<?php
require __DIR__ . '/../vendor/autoload.php';

use App\Services\AuthService;

// Vue HTML principale avec un peu de JS (fetch) pour d√©montrer l'AJAX JSON/XML.
$logged = AuthService::isLogged();
$user   = AuthService::currentUser();
?>
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>TP7 ‚Äî Web dynamique, AJAX & Auth</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- CSS minimaliste externe recommand√© ; ici inline pour compacit√© -->
  <style>
    body{font-family:system-ui,Arial;margin:32px;background:#f6f8fb}
    .card{max-width:980px;margin:auto;background:#fff;padding:24px;border-radius:12px;
          box-shadow:0 8px 24px rgba(0,0,0,.08)}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .box{flex:1 1 300px;background:#fafbff;border:1px solid #e7ebf3;padding:16px;border-radius:10px}
    h1{margin-top:0}
    table{border-collapse:collapse;width:100%;background:#fff}
    th,td{padding:8px;border:1px solid #e1e6ef}
    th{background:#0b63d1;color:#fff}
    .muted{color:#6b7280}
    .ok{color:#177245}
    .warn{color:#b00}
    a{color:#0b63d1;text-decoration:none}
    a:hover{text-decoration:underline}
    input,select,button{padding:8px;border:1px solid #cbd5e1;border-radius:8px}
    .actions a{margin-right:10px}
  </style>
</head>
<body>
<div class="card">
  <h1>TP7 ‚Äî Web dynamique (AJAX JSON/XML) & Authentification</h1>

  <div class="row">
    <div class="box">
      <h3>Authentification</h3>
      <?php if ($logged): ?>
        <p>Connect√© en tant que <strong><?= htmlspecialchars($user) ?></strong></p>
        <p class="actions"><a href="/logout.php">Se d√©connecter</a></p>
      <?php else: ?>
        <p class="muted">Non connect√©</p>
        <p class="actions"><a href="/login.php">Se connecter</a></p>
      <?php endif; ?>
      <p class="muted">D√©mo : admin/admin123 ‚Äî membre/membre123 (‚ö†Ô∏è d√©mo, pas prod)</p>
    </div>

    <div class="box">
      <h3>D√©p√¥t de persistance actif</h3>
      <p>
        <a href="#" data-repo="json"  class="repoBtn">JSON</a> |
        <a href="#" data-repo="sqlite" class="repoBtn">SQLite</a>
      </p>
      <p id="repoState" class="muted">Inconnu‚Ä¶</p>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="box" style="flex:1 1 100%">
      <h3>Liste des utilisateurs (AJAX JSON)</h3>
      <p><button id="btnLoadJson">Charger via /api.php?fmt=json</button></p>
      <div id="jsonResult" class="muted">Cliquez pour charger‚Ä¶</div>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="box">
      <h3>Liste (AJAX XML, parsing DOM)</h3>
      <p><button id="btnLoadXml">Charger via /api.php?fmt=xml</button></p>
      <ul id="xmlList" class="muted"></ul>
    </div>

    <div class="box">
      <h3>Ajout d‚Äôutilisateur (prot√©g√©)</h3>
      <p class="muted">N√©cessite √™tre connect√©</p>
      <div>
        <label>Nom : <input id="nameInput" placeholder="Nom..."></label>
        <label>Type :
          <select id="typeSelect">
            <option value="admin">admin</option>
            <option value="membre" selected>membre</option>
            <option value="visiteur">visiteur</option>
          </select>
        </label>
        <button id="btnAdd">Ajouter (AJAX POST)</button>
      </div>
      <pre id="addOut" class="muted" style="white-space:pre-wrap;margin-top:8px"></pre>
    </div>
  </div>
</div>

<script>
// -- util: r√©cup√©rer/poser le d√©p√¥t choisi en localStorage (json/sqlite)
const repoKey = 'tp7-repo';
function getRepo() { return localStorage.getItem(repoKey) || 'json'; }
function setRepo(v){ localStorage.setItem(repoKey, v); updateRepoState(); }
function updateRepoState(){ document.getElementById('repoState').textContent = 'D√©p√¥t: ' + getRepo(); }
updateRepoState();

// -- boutons de s√©lection du repo
document.querySelectorAll('.repoBtn').forEach(a=>{
  a.addEventListener('click', (e)=>{
    e.preventDefault();
    setRepo(a.dataset.repo);
  });
});

// -- AJAX JSON : GET /api.php?fmt=json&repo=...
document.getElementById('btnLoadJson').addEventListener('click', async ()=>{
  const out = document.getElementById('jsonResult');
  out.textContent = 'Chargement‚Ä¶';
  const res = await fetch('/api.php?fmt=json&action=list&repo=' + encodeURIComponent(getRepo()), {
    headers: { 'Accept': 'application/json' }
  });
  if (!res.ok) { out.textContent = 'Erreur ' + res.status; return; }
  const data = await res.json(); // { items: [ {nom, role, type}, ... ] }
  if (!Array.isArray(data.items)) { out.textContent = 'R√©ponse inattendue'; return; }

  // Remplir un tableau HTML
  let html = '<table><tr><th>Nom</th><th>R√¥le</th><th>Type</th></tr>';
  for (const u of data.items) {
    html += `<tr><td>${escapeHtml(u.nom)}</td><td>${escapeHtml(u.role)}</td><td>${escapeHtml(u.type)}</td></tr>`;
  }
  html += '</table>';
  out.innerHTML = html;
});

// -- AJAX XML : GET /api.php?fmt=xml&repo=...
document.getElementById('btnLoadXml').addEventListener('click', async ()=>{
  const ul = document.getElementById('xmlList');
  ul.textContent = 'Chargement‚Ä¶';
  const res = await fetch('/api.php?fmt=xml&action=list&repo=' + encodeURIComponent(getRepo()), {
    headers: { 'Accept': 'application/xml' }
  });
  if (!res.ok) { ul.textContent = 'Erreur ' + res.status; return; }
  const text = await res.text();
  const doc  = new DOMParser().parseFromString(text, 'application/xml');
  const nodes = doc.querySelectorAll('user');
  ul.innerHTML = '';
  nodes.forEach(n=>{
    const li = document.createElement('li');
    li.textContent = `${n.getAttribute('nom')} ‚Äî ${n.getAttribute('role')} [${n.getAttribute('type')}]`;
    ul.appendChild(li);
  });
});

// -- AJAX POST prot√©g√© : POST /api.php?action=add  (n√©cessite login)
document.getElementById('btnAdd').addEventListener('click', async ()=>{
  const name = document.getElementById('nameInput').value.trim();
  const type = document.getElementById('typeSelect').value;
  const out  = document.getElementById('addOut');
  if (!name) { out.textContent = 'Saisir un nom.'; return; }

  const res = await fetch('/api.php?action=add&repo=' + encodeURIComponent(getRepo()), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
    body: JSON.stringify({ nom: name, type })
  });
  const data = await res.json().catch(()=>({error:'json_failed'}));
  out.textContent = JSON.stringify(data, null, 2);
});

// -- helper XSS-safe
function escapeHtml(s){ return s?.replace(/[&<>"']/g, c => ({'&':'&','<':'<','>':'>','"':'"',"'":'&#039;'}[c])) ?? ''; }
</script>
</body>
</html>
```

**Ce que d√©montre cette page :**

- Chargement **AJAX JSON** et **AJAX XML**.

- **Ajout prot√©g√©** via POST (n√©cessite login).

- **Choix du d√©p√¥t** (json/sqlite) c√¥t√© client, transmis √† l‚ÄôAPI.

---

## 4) Endpoints API (JSON & XML, avec protection)

Cr√©er le fichier **public/api.php** :

```php
<?php
require __DIR__ . '/../vendor/autoload.php';

use App\Services\AuthService;
use App\Services\SessionManager;
use App\Repositories\FileUserRepository;
use App\Repositories\SqliteUserRepository;
use App\Domain\UserRecord;
use App\Core\Admin;
use App\Core\Membre;
use App\Core\Visiteur;

// -- D√©marrage session et CORS (m√™me domaine => CORS non requis ; montr√© √† titre indicatif)
SessionManager::demarrer();

// -- S√©lection repo (comme TP6-s)
$repoName = $_GET['repo'] ?? getenv('APP_REPO') ?? 'json';
$repo = match (strtolower($repoName)) {
    'sqlite' => new SqliteUserRepository(),
    default  => new FileUserRepository(),
};

$fmt    = strtolower($_GET['fmt']    ?? 'json');   // json|xml
$action = strtolower($_GET['action'] ?? 'list');   // list|add|reset

// -- Routeur API minimaliste
switch ($action) {
    case 'list':
        $items = $repo->all(); // array<UserRecord>
        respond($fmt, 200, [
            'items' => array_map(fn($r)=>['nom'=>$r->nom,'role'=>$r->role,'type'=>$r->type], $items)
        ]);
        break;

    case 'add':
        // üîê Protection : login requis
        AuthService::requireLogin();

        // R√©cup√©ration payload JSON
        $payload = json_decode(file_get_contents('php://input'), true) ?? [];
        $nom  = trim((string)($payload['nom']  ?? ''));
        $type = strtolower((string)($payload['type'] ?? ''));

        if ($nom === '' || !in_array($type, ['admin','membre','visiteur'], true)) {
            respond($fmt, 400, ['error' => 'invalid_input', 'hint' => 'nom + type in {admin,membre,visiteur}']);
        }

        // Polymorphisme : construire l‚Äôobjet OO
        $userObj = match ($type) {
            'admin'  => new Admin($nom, 'Administrateur'),
            'membre' => new Membre($nom, 'Membre'),
            default  => new Visiteur($nom, 'Visiteur'),
        };

        $repo->add(new UserRecord($userObj->getNom(), $userObj->getRole(), $type));
        respond($fmt, 201, [
            'ok'      => true,
            'message' => $userObj->seConnecter(),
            'role'    => $userObj->getRole(),
            'type'    => $type
        ]);
        break;

    case 'reset':
        // üîê Protection : login requis
        AuthService::requireLogin();
        $repo->clear();
        respond($fmt, 200, ['ok'=>true,'message'=>'R√©initialis√©','repo'=>$repoName]);
        break;

    default:
        respond($fmt, 404, ['error'=>'not_found']);
}

// ---------- helpers de r√©ponse ----------

/**
 * R√©pond en JSON ou XML selon $fmt.
 * $data est un tableau associatif (cl√© => valeur).
 */
function respond(string $fmt, int $status, array $data): void
{
    http_response_code($status);

    if ($fmt === 'xml') {
        header('Content-Type: application/xml; charset=utf-8');
        echo toXml($data, 'response');
        return;
    }

    // d√©faut: JSON
    header('Content-Type: application/json; charset=utf-8');
    echo json_encode($data, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
}

/** Transforme un array associatif simple en XML (d√©mo) */
function toXml(array $data, string $root = 'response'): string
{
    $xml = new SimpleXMLElement("<{$root}/>");

    $add = function($node, $key, $val) use (&$add) {
        if (is_array($val)) {
            // cas items: [...] => <items><item ... /></items>
            if (isSequential($val)) {
                $list = $node->addChild($key);
                foreach ($val as $entry) {
                    if (is_array($entry)) {
                        $item = $list->addChild('item');
                        foreach ($entry as $k=>$v) {
                            $item->addAttribute($k, (string)$v);
                        }
                    } else {
                        $list->addChild('item', htmlspecialchars((string)$entry));
                    }
                }
            } else {
                $child = $node->addChild($key);
                foreach ($val as $k=>$v) $add($child, $k, $v);
            }
        } else {
            $node->addChild($key, htmlspecialchars((string)$val));
        }
    };

    foreach ($data as $k=>$v) $add($xml, $k, $v);
    // Pour correspondre √† l‚Äôexemple TP : transformer items/item en <users><user .../></users>
    // Optionnel: si la cl√© "items" existe, renommer le conteneur
    $xmlStr = $xml->asXML();
    $xmlStr = str_replace('<items>', '<users>', $xmlStr);
    $xmlStr = str_replace('</items>', '</users>', $xmlStr);
    $xmlStr = str_replace('<item ', '<user ', $xmlStr);
    $xmlStr = str_replace('</item>', '</user>', $xmlStr);
    return $xmlStr;
}

function isSequential(array $a): bool
{
    return array_keys($a) === range(0, count($a)-1);
}
```

**Notes cl√©s :**

- `action=list|add|reset` ; `fmt=json|xml` ; `repo=json|sqlite`.

- `add` et `reset` prot√©g√©s par **AuthService::requireLogin()** ‚Üí 401 si non connect√©.

- L‚ÄôXML est produit proprement ; pour la d√©mo on mappe `<items><item ‚Ä¶/></items>` en `<users><user ‚Ä¶/></users>`.

---

## 5) Login / Logout (formulaire simple)

Cr√©er le fichier **public/login.php** :

```php
<?php
require __DIR__ . '/../vendor/autoload.php';

use App\Services\AuthService;

$error = null;

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $login = trim($_POST['login'] ?? '');
    $pass  = trim($_POST['password'] ?? '');
    if (AuthService::login($login, $pass)) {
        header('Location: /');
        exit;
    }
    $error = "Identifiants incorrects";
}
?>
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Login ‚Äî TP7</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,Arial;margin:32px;background:#f6f8fb}
    .card{max-width:420px;margin:auto;background:#fff;padding:24px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    input,button{width:100%;padding:10px;margin-top:8px;border:1px solid #cbd5e1;border-radius:8px}
    .err{color:#b00}
    a{color:#0b63d1;text-decoration:none}
  </style>
</head>
<body>
<div class="card">
  <h1>Connexion</h1>
  <?php if ($error): ?><p class="err"><?= htmlspecialchars($error) ?></p><?php endif; ?>
  <form method="post" action="/login.php">
    <input name="login" placeholder="login (admin|membre)" required>
    <input name="password" placeholder="mot de passe" type="password" required>
    <button type="submit">Se connecter</button>
  </form>
  <p><a href="/">Retour</a></p>
  <p style="color:#6b7280">D√©mo : admin/admin123 ‚Äî membre/membre123</p>
</div>
</body>
</html>
```

Cr√©er le fichier **public/logout.php** :

```php
<?php
require __DIR__ . '/../vendor/autoload.php';

use App\Services\AuthService;

AuthService::logout();
header('Location: /');
```

---

## 6) Sc√©narios de test

1. **Charger JSON** sans √™tre connect√© :
   
   - Ouvrir `/` ‚Üí cliquer **‚ÄúCharger via /api.php?fmt=json‚Äù** ‚Üí la table s‚Äôaffiche (public).

2. **Charger XML** :
   
   - Cliquer **‚ÄúCharger via /api.php?fmt=xml‚Äù** ‚Üí la liste `<user>` appara√Æt.

3. **Ajouter (prot√©g√©)** sans login :
   
   - Cliquer ‚ÄúAjouter (AJAX POST)‚Äù ‚Üí r√©ponse `{"error":"auth_required"}` (HTTP 401).

4. **Se connecter** :
   
   - `/login.php` ‚Üí `admin/admin123` ‚Üí retour `/`.

5. **Ajouter (prot√©g√©)** en √©tant connect√© :
   
   - Saisir un nom + type, **Ajouter** ‚Üí `{"ok":true, ...}` ; recharger la liste JSON/XML.

6. **Changer de d√©p√¥t** (JSON ‚áÑ SQLite) :
   
   - Choisir **JSON** ou **SQLite** ‚Üí recharger la liste ‚Üí voir la source de donn√©es changer.

7. **Reset (prot√©g√©)** :
   
   - Appeler `/api.php?action=reset&repo=sqlite` via un GET (ou ajoutez un bouton) ‚Üí 200 OK si connect√©.

---

## 7) Pourquoi ce TP est ‚Äúformateur‚Äù

- **Data providers multiples (JSON/XML)** : vous montrez **deux formats** de s√©rialisation via **la m√™me logique**.

- **AJAX** c√¥t√© client : usage **moderne** et propre (`fetch`, parsing JSON/XML).

- **Auth par session** : diff√©rence claire entre **routes publiques** (list) et **prot√©g√©es** (add/reset).

- **Composer toujours pr√©sent** : organisation PSR-4, services injectables, repos interchangeables.

- **S√©paration des responsabilit√©s** : `api.php` pour l‚ÄôAPI, `index.php` pour l‚ÄôUI, services d√©di√©s pour auth/sessions.

---

## 8) Astuces & pi√®ges (et comment les anticiper)

- **401 sur add/reset malgr√© login** : v√©rifiez cookies/navigateur (m√™me origine), et que `SessionManager::demarrer()` est appel√© (il l‚Äôest).

- **CORS** : inutile en m√™me domaine ; si front s√©par√© ‚Üí ajouter les en-t√™tes CORS.

- **Prod** : ne jamais stocker des mots de passe en clair (utiliser `password_hash`, `password_verify`).

- **XML** : le parseur est strict ; bien envoyer `Content-Type: application/xml`.

- **S√©curit√© formulaire** : ajouter CSRF si vous passez en **POST HTML** (ici le POST est JSON c√¥t√© API et m√™me origine).



## Cas 2: M√©canisme d'authentification via Cookie

Voici **un exemple ultra simple, p√©dagogique, minimal** d‚Äôauthentification bas√©e **uniquement sur un cookie**, sans session.

‚ö†Ô∏è Ce n‚Äôest **pas un syst√®me s√©curis√©**, mais il sert √† comprendre la m√©canique.

---

# üü¶ 1. Formulaire de connexion

Cr√©er le fichier **login.php** :

```php
<?php
// Si le formulaire est soumis
if ($_SERVER["REQUEST_METHOD"] === "POST") {

    $username = $_POST["username"] ?? "";
    $password = $_POST["password"] ?? "";

    // Exemple simple : login = admin, password = 1234
    if ($username === "admin" && $password === "1234") {

        // On cr√©e un cookie valable 1 heure
        // httpOnly = true emp√™che l‚Äôacc√®s JS au cookie
        setcookie("auth_user", $username, time() + 3600, "/", "", false, true);

        // Redirection vers la page prot√©g√©e
        header("Location: dashboard.php");
        exit;
    }

    $error = "Identifiants incorrects";
}
?>

<!DOCTYPE html>
<html>
<body>
<h2>Login</h2>

<?php if (!empty($error)) : ?>
<p style="color:red;"><?= $error ?></p>
<?php endif; ?>

<form method="post">
    <label>Utilisateur :</label>
    <input type="text" name="username" required><br><br>

    <label>Mot de passe :</label>
    <input type="password" name="password" required><br><br>

    <button type="submit">Se connecter</button>
</form>

</body>
</html>
```

---

# üü¶ 2. Page prot√©g√©e qui v√©rifie le cookie

Cr√©er le fichier **dashboard.php** :

```php
<?php
// V√©rifier si le cookie existe
if (!isset($_COOKIE["auth_user"])) {
    header("Location: login.php");
    exit;
}

$user = htmlspecialchars($_COOKIE["auth_user"]);
?>

<!DOCTYPE html>
<html>
<body>

<h2>Bonjour <?= $user ?>, vous √™tes connect√© via un cookie !</h2>

<p><a href="logout.php">Se d√©connecter</a></p>

</body>
</html>
```

---

# üü¶ 3. D√©connexion (suppression du cookie)

Cr√©er le fichier **logout.php** :

```php
<?php
// Pour supprimer un cookie, on met une date expir√©e
setcookie("auth_user", "", time() - 3600, "/");

// Redirection
header("Location: login.php");
exit;
```

---

# üü© Comment √ßa marche ?

### üî∏ Lors de la connexion

- PHP v√©rifie le duo `admin / 1234`

- Si OK ‚Üí il place `auth_user=admin` dans un cookie

### üî∏ √Ä la visite de dashboard.php

- Le script v√©rifie si `$_COOKIE["auth_user"]` existe

- Si oui ‚Üí acc√®s autoris√©

- Sinon ‚Üí redirection vers login.php

### üî∏ Lors de la d√©connexion

- On supprime le cookie en mettant une date expir√©e

---

# üü• Limites (important)

Cet exemple est **purement d√©mo**.  
Il manque :

- pas de hachage de mot de passe

- pas de token s√©curis√©

- cookie modifiable par l‚Äôutilisateur

‚û°Ô∏è N‚Äôimporte qui peut cr√©er manuellement un cookie `auth_user=admin`.



Voici un **mini‚Äìcas p√©dagogique tr√®s simple**, parfaitement adapt√© pour vos ateliers :  
un client ‚Üí envoie un **header** ‚Üí l‚ÄôAPI PHP v√©rifie ‚Üí r√©ponse OK ou KO ‚Üí redirection.

Tout est minimaliste, clair, pr√™t √† tester dans un serveur local.

---

# Cas 3: Utilisation des headers dans les sessions

Un **header** (en-t√™te HTTP) est une information envoy√©e dans la requ√™te ou la r√©ponse HTTP.  
Il sert √† transmettre des m√©tadonn√©es comme :

- type de contenu (`Content-Type`),

- cookies (`Set-Cookie`),

- autorisation (`Authorization`),

- redirections (`Location`).

Dans ce cas, nous allons envoyer un header personnalis√© :

```
X-Auth: 12345
```

L‚ÄôAPI va v√©rifier cette valeur.

---

# üîπ üîß Structure du mini-cas

```
mini-demo/
‚îÇ
‚îú‚îÄ‚îÄ client.html          # Page du client (envoie une requ√™te + header)
‚îú‚îÄ‚îÄ api.php              # API PHP : v√©rifie le header
‚îî‚îÄ‚îÄ error.php            # Page affich√©e si √©chec
```

---

# üîπ 1) Page client (envoi d‚Äôun header + affichage du r√©sultat)

Cr√©er le fichier **client.html** :

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Client ‚Üí API</title>
</head>
<body>

<h2>Test communication Client ‚Üí API</h2>

<button id="callApi">Appeler l'API</button>

<p id="result"></p>

<script>
// Quand on clique, on appelle l'API avec un header
document.getElementById('callApi').addEventListener('click', () => {

    fetch("api.php", {
        method: "GET",
        headers: {
            "X-Auth": "12345"   // üëâ Header envoy√© au serveur
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('result').innerText = data.message;
    })
    .catch(() => {
        window.location.href = "error.php"; // redirection en cas d‚Äôerreur fetch
    });
});
</script>

</body>
</html>
```

**Commentaires importants :**

- `fetch()` envoie un header `X-Auth`

- la r√©ponse JSON affichera "OK" ou entra√Ænera une redirection c√¥t√© JS

---

# üîπ 2) API PHP (v√©rification du header)

Cr√©er le fichier **api.php** :

```php
<?php
header("Content-Type: application/json; charset=utf-8");

// On r√©cup√®re tous les headers envoy√©s par le client
$headers = getallheaders();

// V√©rification du header X-Auth
if (!isset($headers['X-Auth']) || $headers['X-Auth'] !== "12345") {
    // Mauvaise cl√© ‚Üí √©chec
    echo json_encode(["message" => "Acc√®s refus√©"]);
    exit;
}

// Si la cl√© est correcte
echo json_encode(["message" => "Acc√®s autoris√©"]);
```

**Explication concise :**

- Nous lisons les headers avec `getallheaders()`

- Si `X-Auth` n‚Äôexiste pas ou n‚Äôest pas correct ‚Üí r√©ponse n√©gative

- Sinon ‚Üí r√©ponse positive

---

# üîπ 3) Page erreur

Cr√©er le fichier **error.php** :

```php
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Erreur</title>
</head>
<body>

<h2>Erreur : Authentification refus√©e</h2>
<p>Le header fourni est invalide ou absent.</p>

</body>
</html>
```

---

# ‚úîÔ∏è Fonctionnement attendu

### üî∏ Cas 1 : header correct

- Le client envoie `X-Auth: 12345`

- `api.php` r√©pond :
  
  ```json
  { "message": "Acc√®s autoris√©" }
  ```

- affichage dans la page client ‚Üí "Acc√®s autoris√©"

### üî∏ Cas 2 : header incorrect ou absent

- L‚ÄôAPI r√©pond :
  
  ```json
  { "message": "Acc√®s refus√©" }
  ```

- JS redirige vers `error.php`



## Cas 3 Authentification via JWT Token

## 1. Contexte & objectif de l‚Äôatelier

### Contexte

- Vous avez un environnement PHP (Windows ou Linux, peu importe).

- Vous voulez montrer √† des d√©butants **comment fonctionne un service web avec JWT** :
  
  - une route `/login.php` qui retourne un token JWT si les identifiants sont corrects,
  
  - une route prot√©g√©e `/me.php` qui n‚Äôest accessible que si le client envoie un **header Authorization: Bearer `.

- Les tests se feront **uniquement avec Postman**, plus accessible que `curl` pour les d√©butants.

### Objectifs p√©dagogiques

√Ä la fin de l‚Äôatelier, le participant doit √™tre capable de :

1. Expliquer bri√®vement ce qu‚Äôest un **JWT** et dans quel contexte on l‚Äôutilise.

2. Comprendre comment **g√©n√©rer un JWT en PHP natif** (sans Composer et sans librairie externe).

3. Comprendre comment **v√©rifier un JWT** c√¥t√© serveur.

4. Utiliser **Postman** pour :
   
   - appeler `/login.php` avec un body JSON,
   
   - r√©cup√©rer le token JWT,
   
   - l‚Äôenvoyer ensuite dans un header `Authorization` √† `/me.php`.

---

## 2. Pr√©paration de l‚Äôenvironnement

### Pr√©requis

- PHP ‚â• 8 install√© (par ex. `C:\phpsource\php` ou autre).

- Un dossier de projet accessible par serveur web :
  
  - soit via Apache / Nginx / MAMP / XAMPP,
  
  - soit via le serveur interne de PHP : `php -S localhost:8000`.

- **Postman** install√© (desktop app).

### Structure du projet

Nous allons cr√©er un dossier `jwt-demo` avec les fichiers suivants :

```
jwt-demo/
‚îÇ
‚îú‚îÄ‚îÄ config.php      # config globale + fonction utilitaire pour JSON
‚îú‚îÄ‚îÄ jwt.php         # fonctions pour cr√©er et v√©rifier un JWT
‚îú‚îÄ‚îÄ login.php       # endpoint de login : g√©n√®re un token JWT
‚îî‚îÄ‚îÄ me.php          # endpoint prot√©g√©, n√©cessite un JWT valide
```

Placez `jwt-demo` :

- soit dans le r√©pertoire racine de votre serveur web (ex : `C:\Apache24\htdocs\jwt-demo`),

- soit dans un dossier de travail si vous utilisez `php -S`.

---

## 3. √âtapes d‚Äôex√©cution d√©taill√©es

### √âtape 1 ‚Äì Cr√©er le fichier de configuration `config.php`

**R√¥le :**

- Centraliser la **cl√© secr√®te** utilis√©e pour signer les JWT.

- Fournir une fonction `json_response()` pour envoyer des r√©ponses JSON propres.

Cr√©er le fichier **config.php** :

```php
<?php
// config.php
// Fichier de configuration simple pour le mini service web JWT

// Cl√© secr√®te utilis√©e pour signer les JWT.
// ‚ö† En production : cl√© beaucoup plus longue, stock√©e dans une variable d'environnement.
const JWT_SECRET = 'ma_cle_secrete_tres_simple';

// Fonction utilitaire pour envoyer une r√©ponse JSON propre au client.
function json_response(array $data, int $statusCode = 200): void
{
    // D√©finir le code HTTP de la r√©ponse (200, 400, 401, 500, etc.)
    http_response_code($statusCode);

    // Pr√©ciser que le contenu renvoy√© est du JSON en UTF-8
    header('Content-Type: application/json; charset=utf-8');

    // Encoder le tableau PHP en JSON et l'envoyer au client
    echo json_encode($data);

    // Arr√™ter le script imm√©diatement apr√®s la r√©ponse
    exit;
}
```

---

### √âtape 2 ‚Äì Cr√©er le fichier `jwt.php` (fonctions JWT)

**R√¥le :**

- Fournir :
  
  - `create_jwt(array $payload): string` ‚Üí g√©n√®re un token JWT sign√©.
  
  - `verify_jwt(string $token): ?array` ‚Üí v√©rifie le token et retourne les donn√©es (payload) ou `null`.

Cr√©er le fichier **jwt.php** :

```php
<?php
// jwt.php
// Fonctions minimalistes pour cr√©er et v√©rifier un JWT sans librairie externe.

require_once __DIR__ . '/config.php';

// Encodage en base64url : variante base64 adapt√©e aux URLs (sans +, /, =)
function base64url_encode(string $data): string
{
    // base64_encode standard
    $base64 = base64_encode($data);

    // Remplacer les caract√®res non adapt√©s aux URLs et supprimer les '=' finaux
    return rtrim(strtr($base64, '+/', '-_'), '=');
}

// D√©codage en base64url : op√©ration inverse de base64url_encode
function base64url_decode(string $data): string
{
    // Remettre les caract√®res de base64 standard
    $base64 = strtr($data, '-_', '+/');

    // Ajouter les '=' manquants si n√©cessaire
    $padLen = 4 - (strlen($base64) % 4);
    if ($padLen < 4) {
        $base64 .= str_repeat('=', $padLen);
    }

    // D√©coder en binaire
    return base64_decode($base64);
}

// Cr√©ation d'un JWT sign√© avec l'algorithme HS256
function create_jwt(array $payload): string
{
    // Header du JWT : type du token (JWT) + algorithme de signature (HS256)
    $header = [
        'typ' => 'JWT',
        'alg' => 'HS256',
    ];

    // Encoder header et payload en JSON puis en base64url
    $headerEncoded  = base64url_encode(json_encode($header));
    $payloadEncoded = base64url_encode(json_encode($payload));

    // Construire la cha√Æne √† signer : "header.payload"
    $dataToSign = $headerEncoded . '.' . $payloadEncoded;

    // Signature HMAC-SHA256 avec la cl√© secr√®te
    $signature = hash_hmac(
        'sha256',
        $dataToSign,
        JWT_SECRET,
        true // true = sortie binaire (non hexad√©cimale)
    );

    // Encodage de la signature en base64url
    $signatureEncoded = base64url_encode($signature);

    // Token final : "header.payload.signature"
    return $headerEncoded . '.' . $payloadEncoded . '.' . $signatureEncoded;
}

// V√©rification d'un JWT : retourne le payload (tableau) ou null si invalide
function verify_jwt(string $token): ?array
{
    // D√©couper le token en 3 parties s√©par√©es par des points
    $parts = explode('.', $token);
    if (count($parts) !== 3) {
        // Mauvais format de token
        return null;
    }

    [$headerEncoded, $payloadEncoded, $signatureEncoded] = $parts;

    // Recalculer la signature attendue √† partir du header et du payload
    $dataToSign = $headerEncoded . '.' . $payloadEncoded;

    $expectedSignature = base64url_encode(
        hash_hmac(
            'sha256',
            $dataToSign,
            JWT_SECRET,
            true
        )
    );

    // Comparer la signature envoy√©e avec la signature recalcul√©e
    if (!hash_equals($expectedSignature, $signatureEncoded)) {
        // Signature invalide ‚Üí token falsifi√© ou cl√© incorrecte
        return null;
    }

    // D√©coder le payload JSON
    $payloadJson = base64url_decode($payloadEncoded);
    $payload = json_decode($payloadJson, true);

    // Si on n'obtient pas un tableau, le token est invalide
    if (!is_array($payload)) {
        return null;
    }

    // V√©rifier la date d'expiration (champ "exp") si pr√©sente
    if (isset($payload['exp']) && time() > $payload['exp']) {
        // Token expir√©
        return null;
    }

    // Si tout est bon, on retourne le payload (donn√©es du token)
    return $payload;
}
```

---

### √âtape 3 ‚Äì Cr√©er l‚Äôendpoint `login.php` (g√©n√®re un JWT)

**R√¥le :**

- Recevoir un JSON avec `username` et `password` (via POST).

- V√©rifier les identifiants (en dur pour la d√©mo).

- G√©n√©rer un JWT avec `create_jwt()`.

- Retourner le JWT au client.

Cr√©er le fichier **login.php** :

```php
<?php
// login.php
// Endpoint de connexion : renvoie un token JWT si les identifiants sont corrects.

require_once __DIR__ . '/config.php';
require_once __DIR__ . '/jwt.php';

// On n'accepte que la m√©thode HTTP POST pour ce endpoint
if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    json_response(['error' => 'M√©thode non autoris√©e. Utiliser POST.'], 405);
}

// R√©cup√©rer le corps brut de la requ√™te (JSON)
$rawBody = file_get_contents('php://input');

// D√©coder le JSON en tableau PHP associatif
$data = json_decode($rawBody, true);

// Extraire username et password (ou null s'ils n'existent pas)
$username = $data['username'] ?? null;
$password = $data['password'] ?? null;

// V√©rification minimale des champs requis
if ($username === null || $password === null) {
    json_response(['error' => 'Champs "username" et "password" requis.'], 400);
}

// Pour la d√©mo : identifiants cod√©s en dur.
// En production : comparaison avec une base de donn√©es + password hash.
if ($username !== 'admin' || $password !== 'secret') {
    json_response(['error' => 'Identifiants invalides.'], 401);
}

// Construire le payload du token JWT
$payload = [
    'sub' => $username,          // "subject" = identifiant de l'utilisateur
    'role' => 'admin_demo',      // Exemple de r√¥le
    'iat' => time(),             // "issued at" = date de cr√©ation du token
    'exp' => time() + 3600,      // "expiration" = maintenant + 3600 secondes (1h)
];

// Cr√©ation du token JWT
$token = create_jwt($payload);

// Retourner une r√©ponse JSON avec le token
json_response([
    'message' => 'Connexion r√©ussie.',
    'token'   => $token,
]);
```

---

### √âtape 4 ‚Äì Cr√©er l‚Äôendpoint prot√©g√© `me.php`

**R√¥le :**

- Lire le header `Authorization: Bearer <token>`.

- V√©rifier le token via `verify_jwt()`.

- Si valide ‚Üí retourner les infos de l‚Äôutilisateur.

- Si invalide ‚Üí renvoyer une erreur 401.

Cr√©er le fichier **me.php** :

```php
<?php
// me.php
// Endpoint prot√©g√© par JWT : n√©cessite un header Authorization: Bearer <token>

require_once __DIR__ . '/config.php';
require_once __DIR__ . '/jwt.php';

// R√©cup√©rer tous les en-t√™tes HTTP de la requ√™te
$headers = getallheaders();

// R√©cup√©rer le header Authorization s'il existe
$authHeader = $headers['Authorization'] ?? '';

// V√©rifier que le header commence par "Bearer "
// str_starts_with est disponible √† partir de PHP 8.
if (!str_starts_with($authHeader, 'Bearer ')) {
    json_response(['error' => 'Header Authorization Bearer manquant ou incorrect.'], 401);
}

// Extraire le token JWT apr√®s le mot "Bearer "
$token = trim(substr($authHeader, 7));

// V√©rifier le token avec notre fonction utilitaire
$payload = verify_jwt($token);

// Si la v√©rification √©choue, renvoyer une erreur 401
if ($payload === null) {
    json_response(['error' => 'Token invalide ou expir√©.'], 401);
}

// Si on arrive ici, le token est valide.
// On renvoie les informations contenues dans le payload.
json_response([
    'message' => 'Acc√®s autoris√©.',
    'user'    => [
        'username' => $payload['sub'] ?? null,
        'role'     => $payload['role'] ?? null,
        'exp'      => $payload['exp'] ?? null,
    ],
]);
```

---

### √âtape 5 ‚Äì Lancer le serveur PHP

#### Option A ‚Äì Serveur interne PHP (simple pour d√©mo)

Dans un terminal positionn√© dans le dossier parent de `jwt-demo` :

```bash
php -S localhost:8000
```

Cela rendra votre projet accessible √† l‚Äôadresse :

- `http://localhost:8000/jwt-demo/login.php`

- `http://localhost:8000/jwt-demo/me.php`

*(adapter si votre arborescence diff√®re)*

#### Option B ‚Äì Apache / MAMP / XAMPP

- Placez le dossier `jwt-demo` dans `htdocs` ou `www`, par ex. `C:\Apache24\htdocs\jwt-demo`.

- Acc√©dez ensuite √† :
  
  - `http://localhost/jwt-demo/login.php`
  
  - `http://localhost/jwt-demo/me.php`

---

### √âtape 6 ‚Äì Tests complets avec Postman

#### 6.1. Tester `/login.php` (obtenir un token JWT)

1. Ouvrir Postman.

2. Cliquer sur **New ‚Üí HTTP Request**.

3. M√©thode : **POST**.

4. URL (adapter selon votre cas) :
   
   - Avec serveur interne PHP :  
     `http://localhost:8000/jwt-demo/login.php`
   
   - Avec Apache :  
     `http://localhost/jwt-demo/login.php`

5. Onglet **Body** :
   
   - S√©lectionner **raw**.
   
   - Type : **JSON**.
   
   - Mettre ce contenu :

```json
{
  "username": "admin",
  "password": "secret"
}
```

6. Cliquer sur **Send**.

**R√©sultat attendu :**

```json
{
  "message": "Connexion r√©ussie.",
  "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
}
```

‚û°Ô∏è Copier la valeur du champ `token` (enti√®re).

---

#### 6.2. Tester `/me.php` (endpoint prot√©g√©)

1. Cr√©er une nouvelle requ√™te dans Postman (ou dupliquer la pr√©c√©dente).

2. M√©thode : **GET**.

3. URL :
   
   - Avec serveur interne PHP :  
     `http://localhost:8000/jwt-demo/me.php`
   
   - Avec Apache :  
     `http://localhost/jwt-demo/me.php`

4. Aller dans l‚Äôonglet **Headers**.

5. Ajouter une ligne :
   
   | Key           | Value                        |
   | ------------- | ---------------------------- |
   | Authorization | Bearer VOTRE_TOKEN_COPI√â_ICI |
   
   Exemple :
   
   ```
   Authorization : Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...
   ```

6. Cliquer sur **Send**.

**R√©sultat attendu (token valide) :**

```json
{
  "message": "Acc√®s autoris√©.",
  "user": {
    "username": "admin",
    "role": "admin_demo",
    "exp": 1731600000
  }
}
```

---

#### 6.3. Tester les cas d‚Äôerreur (pour la p√©dagogie)

- **Sans header Authorization :**
  
  - Supprimer la ligne `Authorization` dans Postman.
  
  - R√©sultat attendu :
    
    ```json
    {
      "error": "Header Authorization Bearer manquant ou incorrect."
    }
    ```

- **Avec token bidon :**
  
  - Mettre : `Authorization: Bearer abc123`
  
  - R√©sultat :
    
    ```json
    {
      "error": "Token invalide ou expir√©."
    }
    ```

- **Avec mauvais identifiants sur /login.php :**
  
  - Changer `password` en `"wrong"`.
  
  - R√©sultat :
    
    ```json
    {
      "error": "Identifiants invalides."
    }
    ```

---

## 4. V√©rifications / R√©sultats attendus

√Ä la fin de l‚Äôatelier, v√©rifiez que les participants savent :

1. **Montrer le body JSON dans Postman** pour `/login.php`.

2. **Localiser le token dans la r√©ponse JSON**.

3. **Cr√©er un header Authorization** dans Postman pour `/me.php`.

4. Expliquer en une phrase :
   
   - √† quoi sert `login.php`,
   
   - √† quoi sert `me.php`,
   
   - √† quoi sert le **header Authorization**.

---

## 5. Nettoyage / Rollback

Pour nettoyer l‚Äôenvironnement apr√®s la d√©monstration :

1. Supprimer le dossier `jwt-demo` si ce n‚Äôest plus utile.

2. Arr√™ter le serveur int√©gr√© PHP (`Ctrl + C` dans le terminal).

3. √âventuellement supprimer les requ√™tes Postman de test ou les archiver dans une collection ‚ÄúD√©mo JWT‚Äù.

---

## 6. Tips & pi√®ges √† √©viter

- **Ne jamais** exposer une cl√© secr√®te faible en production comme dans l‚Äôexemple.

- Toujours utiliser **HTTPS** quand on joue avec des tokens.

- √âviter `$_SESSION` pour une API REST ‚Üí privil√©gier des tokens stateless comme JWT.

- Bien insister aupr√®s des d√©butants sur le r√¥le du header :
  
  > Le header `Authorization: Bearer <token>`  
  > est le ‚Äúbadge‚Äù que le client pr√©sente √† chaque requ√™te pour prouver son identit√©.

---

Si tu veux, on pourra faire tout de suite **une V2 de cet atelier** :

- en rempla√ßant les identifiants en dur par une vraie table MySQL `users`,

- ou en ajoutant un **refresh token** pour une d√©mo plus avanc√©e.


