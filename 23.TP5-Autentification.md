

# üéì TP7 ‚Äî Web dynamique, AJAX (JSON/XML) & Authentification par sessions

## üéØ Objectifs

- Servir des donn√©es **JSON** et **XML** depuis votre app (m√™me domaine).

- Consommer ces donn√©es c√¥t√© **front** avec `fetch()` (AJAX) pour rafra√Æchir sans recharger la page.

- Mettre en place une **authentification par session** (login/logout) prot√©geant certaines actions (ex. ajout d‚Äôutilisateur).

- Garder **Composer (PSR-4)** et l‚Äôarchitecture propre (Repository JSON/SQLite d√©j√† faits).

> Pr√©-requis : TP6 + TP6 (suite) fonctionnels (autoload PSR-4 actif).

---

## 1) Structure cible

```
tp7-app/ (vous pouvez √©voluer depuis tp6-app)
‚îú‚îÄ‚îÄ composer.json                 (autoload PSR-4 "App\\": "src/")
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îú‚îÄ‚îÄ users.json                (si repo=json)
‚îÇ   ‚îî‚îÄ‚îÄ app.db                    (si repo=sqlite)
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îú‚îÄ‚îÄ index.php                 (UI + fetch AJAX)
‚îÇ   ‚îú‚îÄ‚îÄ login.php                 (formulaire HTML + POST)
‚îÇ   ‚îú‚îÄ‚îÄ logout.php                (d√©connexion)
‚îÇ   ‚îî‚îÄ‚îÄ api.php                   (endpoints JSON/XML s√©curis√©s)
‚îî‚îÄ‚îÄ src/
    ‚îú‚îÄ‚îÄ App.php                   (inchang√© depuis TP6 suite)
    ‚îú‚îÄ‚îÄ Services/
    ‚îÇ   ‚îú‚îÄ‚îÄ SessionManager.php    (existant)
    ‚îÇ   ‚îî‚îÄ‚îÄ AuthService.php       (NOUVEAU)
    ‚îú‚îÄ‚îÄ Interfaces/               (Authentifiable.php, UserRepository.php)
    ‚îú‚îÄ‚îÄ Domain/                   (UserRecord.php)
    ‚îú‚îÄ‚îÄ Core/                     (Utilisateur + Admin/Membre/Visiteur)
    ‚îî‚îÄ‚îÄ Repositories/             (FileUserRepository + SqliteUserRepository)
```

---

## 2) Service d‚Äôauthentification

Cr√©er le fichier **src/Services/AuthService.php** :

```php
<?php
namespace App\Services;

/**
 * AuthService ‚Äî Authentification simple par sessions.
 * - Utilise SessionManager (d√©marrage, set/get, destroy).
 * - D√©mo p√©dagogique : identifiants cod√©s en dur (√† remplacer par une base/LDAP plus tard).
 */
class AuthService
{
    private const USERS = [
        // login => password (hash√©s en prod ! Ici pour d√©mo : clair)
        'admin'  => 'admin123',
        'membre' => 'membre123',
    ];

    /** Retourne true si un utilisateur est connect√© */
    public static function isLogged(): bool
    {
        SessionManager::demarrer();
        return (bool) SessionManager::get('auth_user');
    }

    /** Retourne le login courant ou null */
    public static function currentUser(): ?string
    {
        SessionManager::demarrer();
        return SessionManager::get('auth_user');
    }

    /** Tentative de login : true si OK */
    public static function login(string $login, string $password): bool
    {
        SessionManager::demarrer();

        // ‚ö†Ô∏è D√©mo : check simple (en prod : hash, rate limit, CSRF, etc.)
        if (isset(self::USERS[$login]) && self::USERS[$login] === $password) {
            SessionManager::set('auth_user', $login);
            return true;
        }
        return false;
    }

    /** D√©connexion */
    public static function logout(): void
    {
        SessionManager::demarrer();
        SessionManager::detruire();
    }

    /**
     * Protection d'action : l√®ve une erreur si non connect√©
     * √Ä utiliser c√¥t√© API pour les routes prot√©g√©es.
     */
    public static function requireLogin(): void
    {
        if (!self::isLogged()) {
            http_response_code(401);
            header('Content-Type: application/json; charset=utf-8');
            echo json_encode(['error' => 'auth_required'], JSON_UNESCAPED_UNICODE);
            exit;
        }
    }
}
```

---

## 3) Page d‚Äôaccueil (UI + AJAX)

Cr√©er le fichier **public/index.php** :

```php
<?php
require __DIR__ . '/../vendor/autoload.php';

use App\Services\AuthService;

// Vue HTML principale avec un peu de JS (fetch) pour d√©montrer l'AJAX JSON/XML.
$logged = AuthService::isLogged();
$user   = AuthService::currentUser();
?>
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>TP7 ‚Äî Web dynamique, AJAX & Auth</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- CSS minimaliste externe recommand√© ; ici inline pour compacit√© -->
  <style>
    body{font-family:system-ui,Arial;margin:32px;background:#f6f8fb}
    .card{max-width:980px;margin:auto;background:#fff;padding:24px;border-radius:12px;
          box-shadow:0 8px 24px rgba(0,0,0,.08)}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .box{flex:1 1 300px;background:#fafbff;border:1px solid #e7ebf3;padding:16px;border-radius:10px}
    h1{margin-top:0}
    table{border-collapse:collapse;width:100%;background:#fff}
    th,td{padding:8px;border:1px solid #e1e6ef}
    th{background:#0b63d1;color:#fff}
    .muted{color:#6b7280}
    .ok{color:#177245}
    .warn{color:#b00}
    a{color:#0b63d1;text-decoration:none}
    a:hover{text-decoration:underline}
    input,select,button{padding:8px;border:1px solid #cbd5e1;border-radius:8px}
    .actions a{margin-right:10px}
  </style>
</head>
<body>
<div class="card">
  <h1>TP7 ‚Äî Web dynamique (AJAX JSON/XML) & Authentification</h1>

  <div class="row">
    <div class="box">
      <h3>Authentification</h3>
      <?php if ($logged): ?>
        <p>Connect√© en tant que <strong><?= htmlspecialchars($user) ?></strong></p>
        <p class="actions"><a href="/logout.php">Se d√©connecter</a></p>
      <?php else: ?>
        <p class="muted">Non connect√©</p>
        <p class="actions"><a href="/login.php">Se connecter</a></p>
      <?php endif; ?>
      <p class="muted">D√©mo : admin/admin123 ‚Äî membre/membre123 (‚ö†Ô∏è d√©mo, pas prod)</p>
    </div>

    <div class="box">
      <h3>D√©p√¥t de persistance actif</h3>
      <p>
        <a href="#" data-repo="json"  class="repoBtn">JSON</a> |
        <a href="#" data-repo="sqlite" class="repoBtn">SQLite</a>
      </p>
      <p id="repoState" class="muted">Inconnu‚Ä¶</p>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="box" style="flex:1 1 100%">
      <h3>Liste des utilisateurs (AJAX JSON)</h3>
      <p><button id="btnLoadJson">Charger via /api.php?fmt=json</button></p>
      <div id="jsonResult" class="muted">Cliquez pour charger‚Ä¶</div>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="box">
      <h3>Liste (AJAX XML, parsing DOM)</h3>
      <p><button id="btnLoadXml">Charger via /api.php?fmt=xml</button></p>
      <ul id="xmlList" class="muted"></ul>
    </div>

    <div class="box">
      <h3>Ajout d‚Äôutilisateur (prot√©g√©)</h3>
      <p class="muted">N√©cessite √™tre connect√©</p>
      <div>
        <label>Nom : <input id="nameInput" placeholder="Nom..."></label>
        <label>Type :
          <select id="typeSelect">
            <option value="admin">admin</option>
            <option value="membre" selected>membre</option>
            <option value="visiteur">visiteur</option>
          </select>
        </label>
        <button id="btnAdd">Ajouter (AJAX POST)</button>
      </div>
      <pre id="addOut" class="muted" style="white-space:pre-wrap;margin-top:8px"></pre>
    </div>
  </div>
</div>

<script>
// -- util: r√©cup√©rer/poser le d√©p√¥t choisi en localStorage (json/sqlite)
const repoKey = 'tp7-repo';
function getRepo() { return localStorage.getItem(repoKey) || 'json'; }
function setRepo(v){ localStorage.setItem(repoKey, v); updateRepoState(); }
function updateRepoState(){ document.getElementById('repoState').textContent = 'D√©p√¥t: ' + getRepo(); }
updateRepoState();

// -- boutons de s√©lection du repo
document.querySelectorAll('.repoBtn').forEach(a=>{
  a.addEventListener('click', (e)=>{
    e.preventDefault();
    setRepo(a.dataset.repo);
  });
});

// -- AJAX JSON : GET /api.php?fmt=json&repo=...
document.getElementById('btnLoadJson').addEventListener('click', async ()=>{
  const out = document.getElementById('jsonResult');
  out.textContent = 'Chargement‚Ä¶';
  const res = await fetch('/api.php?fmt=json&action=list&repo=' + encodeURIComponent(getRepo()), {
    headers: { 'Accept': 'application/json' }
  });
  if (!res.ok) { out.textContent = 'Erreur ' + res.status; return; }
  const data = await res.json(); // { items: [ {nom, role, type}, ... ] }
  if (!Array.isArray(data.items)) { out.textContent = 'R√©ponse inattendue'; return; }

  // Remplir un tableau HTML
  let html = '<table><tr><th>Nom</th><th>R√¥le</th><th>Type</th></tr>';
  for (const u of data.items) {
    html += `<tr><td>${escapeHtml(u.nom)}</td><td>${escapeHtml(u.role)}</td><td>${escapeHtml(u.type)}</td></tr>`;
  }
  html += '</table>';
  out.innerHTML = html;
});

// -- AJAX XML : GET /api.php?fmt=xml&repo=...
document.getElementById('btnLoadXml').addEventListener('click', async ()=>{
  const ul = document.getElementById('xmlList');
  ul.textContent = 'Chargement‚Ä¶';
  const res = await fetch('/api.php?fmt=xml&action=list&repo=' + encodeURIComponent(getRepo()), {
    headers: { 'Accept': 'application/xml' }
  });
  if (!res.ok) { ul.textContent = 'Erreur ' + res.status; return; }
  const text = await res.text();
  const doc  = new DOMParser().parseFromString(text, 'application/xml');
  const nodes = doc.querySelectorAll('user');
  ul.innerHTML = '';
  nodes.forEach(n=>{
    const li = document.createElement('li');
    li.textContent = `${n.getAttribute('nom')} ‚Äî ${n.getAttribute('role')} [${n.getAttribute('type')}]`;
    ul.appendChild(li);
  });
});

// -- AJAX POST prot√©g√© : POST /api.php?action=add  (n√©cessite login)
document.getElementById('btnAdd').addEventListener('click', async ()=>{
  const name = document.getElementById('nameInput').value.trim();
  const type = document.getElementById('typeSelect').value;
  const out  = document.getElementById('addOut');
  if (!name) { out.textContent = 'Saisir un nom.'; return; }

  const res = await fetch('/api.php?action=add&repo=' + encodeURIComponent(getRepo()), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
    body: JSON.stringify({ nom: name, type })
  });
  const data = await res.json().catch(()=>({error:'json_failed'}));
  out.textContent = JSON.stringify(data, null, 2);
});

// -- helper XSS-safe
function escapeHtml(s){ return s?.replace(/[&<>"']/g, c => ({'&':'&','<':'<','>':'>','"':'"',"'":'&#039;'}[c])) ?? ''; }
</script>
</body>
</html>
```

**Ce que d√©montre cette page :**

- Chargement **AJAX JSON** et **AJAX XML**.

- **Ajout prot√©g√©** via POST (n√©cessite login).

- **Choix du d√©p√¥t** (json/sqlite) c√¥t√© client, transmis √† l‚ÄôAPI.

---

## 4) Endpoints API (JSON & XML, avec protection)

Cr√©er le fichier **public/api.php** :

```php
<?php
require __DIR__ . '/../vendor/autoload.php';

use App\Services\AuthService;
use App\Services\SessionManager;
use App\Repositories\FileUserRepository;
use App\Repositories\SqliteUserRepository;
use App\Domain\UserRecord;
use App\Core\Admin;
use App\Core\Membre;
use App\Core\Visiteur;

// -- D√©marrage session et CORS (m√™me domaine => CORS non requis ; montr√© √† titre indicatif)
SessionManager::demarrer();

// -- S√©lection repo (comme TP6-s)
$repoName = $_GET['repo'] ?? getenv('APP_REPO') ?? 'json';
$repo = match (strtolower($repoName)) {
    'sqlite' => new SqliteUserRepository(),
    default  => new FileUserRepository(),
};

$fmt    = strtolower($_GET['fmt']    ?? 'json');   // json|xml
$action = strtolower($_GET['action'] ?? 'list');   // list|add|reset

// -- Routeur API minimaliste
switch ($action) {
    case 'list':
        $items = $repo->all(); // array<UserRecord>
        respond($fmt, 200, [
            'items' => array_map(fn($r)=>['nom'=>$r->nom,'role'=>$r->role,'type'=>$r->type], $items)
        ]);
        break;

    case 'add':
        // üîê Protection : login requis
        AuthService::requireLogin();

        // R√©cup√©ration payload JSON
        $payload = json_decode(file_get_contents('php://input'), true) ?? [];
        $nom  = trim((string)($payload['nom']  ?? ''));
        $type = strtolower((string)($payload['type'] ?? ''));

        if ($nom === '' || !in_array($type, ['admin','membre','visiteur'], true)) {
            respond($fmt, 400, ['error' => 'invalid_input', 'hint' => 'nom + type in {admin,membre,visiteur}']);
        }

        // Polymorphisme : construire l‚Äôobjet OO
        $userObj = match ($type) {
            'admin'  => new Admin($nom, 'Administrateur'),
            'membre' => new Membre($nom, 'Membre'),
            default  => new Visiteur($nom, 'Visiteur'),
        };

        $repo->add(new UserRecord($userObj->getNom(), $userObj->getRole(), $type));
        respond($fmt, 201, [
            'ok'      => true,
            'message' => $userObj->seConnecter(),
            'role'    => $userObj->getRole(),
            'type'    => $type
        ]);
        break;

    case 'reset':
        // üîê Protection : login requis
        AuthService::requireLogin();
        $repo->clear();
        respond($fmt, 200, ['ok'=>true,'message'=>'R√©initialis√©','repo'=>$repoName]);
        break;

    default:
        respond($fmt, 404, ['error'=>'not_found']);
}

// ---------- helpers de r√©ponse ----------

/**
 * R√©pond en JSON ou XML selon $fmt.
 * $data est un tableau associatif (cl√© => valeur).
 */
function respond(string $fmt, int $status, array $data): void
{
    http_response_code($status);

    if ($fmt === 'xml') {
        header('Content-Type: application/xml; charset=utf-8');
        echo toXml($data, 'response');
        return;
    }

    // d√©faut: JSON
    header('Content-Type: application/json; charset=utf-8');
    echo json_encode($data, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
}

/** Transforme un array associatif simple en XML (d√©mo) */
function toXml(array $data, string $root = 'response'): string
{
    $xml = new SimpleXMLElement("<{$root}/>");

    $add = function($node, $key, $val) use (&$add) {
        if (is_array($val)) {
            // cas items: [...] => <items><item ... /></items>
            if (isSequential($val)) {
                $list = $node->addChild($key);
                foreach ($val as $entry) {
                    if (is_array($entry)) {
                        $item = $list->addChild('item');
                        foreach ($entry as $k=>$v) {
                            $item->addAttribute($k, (string)$v);
                        }
                    } else {
                        $list->addChild('item', htmlspecialchars((string)$entry));
                    }
                }
            } else {
                $child = $node->addChild($key);
                foreach ($val as $k=>$v) $add($child, $k, $v);
            }
        } else {
            $node->addChild($key, htmlspecialchars((string)$val));
        }
    };

    foreach ($data as $k=>$v) $add($xml, $k, $v);
    // Pour correspondre √† l‚Äôexemple TP : transformer items/item en <users><user .../></users>
    // Optionnel: si la cl√© "items" existe, renommer le conteneur
    $xmlStr = $xml->asXML();
    $xmlStr = str_replace('<items>', '<users>', $xmlStr);
    $xmlStr = str_replace('</items>', '</users>', $xmlStr);
    $xmlStr = str_replace('<item ', '<user ', $xmlStr);
    $xmlStr = str_replace('</item>', '</user>', $xmlStr);
    return $xmlStr;
}

function isSequential(array $a): bool
{
    return array_keys($a) === range(0, count($a)-1);
}
```

**Notes cl√©s :**

- `action=list|add|reset` ; `fmt=json|xml` ; `repo=json|sqlite`.

- `add` et `reset` prot√©g√©s par **AuthService::requireLogin()** ‚Üí 401 si non connect√©.

- L‚ÄôXML est produit proprement ; pour la d√©mo on mappe `<items><item ‚Ä¶/></items>` en `<users><user ‚Ä¶/></users>`.

---

## 5) Login / Logout (formulaire simple)

Cr√©er le fichier **public/login.php** :

```php
<?php
require __DIR__ . '/../vendor/autoload.php';

use App\Services\AuthService;

$error = null;

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $login = trim($_POST['login'] ?? '');
    $pass  = trim($_POST['password'] ?? '');
    if (AuthService::login($login, $pass)) {
        header('Location: /');
        exit;
    }
    $error = "Identifiants incorrects";
}
?>
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Login ‚Äî TP7</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,Arial;margin:32px;background:#f6f8fb}
    .card{max-width:420px;margin:auto;background:#fff;padding:24px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    input,button{width:100%;padding:10px;margin-top:8px;border:1px solid #cbd5e1;border-radius:8px}
    .err{color:#b00}
    a{color:#0b63d1;text-decoration:none}
  </style>
</head>
<body>
<div class="card">
  <h1>Connexion</h1>
  <?php if ($error): ?><p class="err"><?= htmlspecialchars($error) ?></p><?php endif; ?>
  <form method="post" action="/login.php">
    <input name="login" placeholder="login (admin|membre)" required>
    <input name="password" placeholder="mot de passe" type="password" required>
    <button type="submit">Se connecter</button>
  </form>
  <p><a href="/">Retour</a></p>
  <p style="color:#6b7280">D√©mo : admin/admin123 ‚Äî membre/membre123</p>
</div>
</body>
</html>
```

Cr√©er le fichier **public/logout.php** :

```php
<?php
require __DIR__ . '/../vendor/autoload.php';

use App\Services\AuthService;

AuthService::logout();
header('Location: /');
```

---

## 6) Sc√©narios de test

1. **Charger JSON** sans √™tre connect√© :
   
   - Ouvrir `/` ‚Üí cliquer **‚ÄúCharger via /api.php?fmt=json‚Äù** ‚Üí la table s‚Äôaffiche (public).

2. **Charger XML** :
   
   - Cliquer **‚ÄúCharger via /api.php?fmt=xml‚Äù** ‚Üí la liste `<user>` appara√Æt.

3. **Ajouter (prot√©g√©)** sans login :
   
   - Cliquer ‚ÄúAjouter (AJAX POST)‚Äù ‚Üí r√©ponse `{"error":"auth_required"}` (HTTP 401).

4. **Se connecter** :
   
   - `/login.php` ‚Üí `admin/admin123` ‚Üí retour `/`.

5. **Ajouter (prot√©g√©)** en √©tant connect√© :
   
   - Saisir un nom + type, **Ajouter** ‚Üí `{"ok":true, ...}` ; recharger la liste JSON/XML.

6. **Changer de d√©p√¥t** (JSON ‚áÑ SQLite) :
   
   - Choisir **JSON** ou **SQLite** ‚Üí recharger la liste ‚Üí voir la source de donn√©es changer.

7. **Reset (prot√©g√©)** :
   
   - Appeler `/api.php?action=reset&repo=sqlite` via un GET (ou ajoutez un bouton) ‚Üí 200 OK si connect√©.

---

## 7) Pourquoi ce TP est ‚Äúformateur‚Äù

- **Data providers multiples (JSON/XML)** : vous montrez **deux formats** de s√©rialisation via **la m√™me logique**.

- **AJAX** c√¥t√© client : usage **moderne** et propre (`fetch`, parsing JSON/XML).

- **Auth par session** : diff√©rence claire entre **routes publiques** (list) et **prot√©g√©es** (add/reset).

- **Composer toujours pr√©sent** : organisation PSR-4, services injectables, repos interchangeables.

- **S√©paration des responsabilit√©s** : `api.php` pour l‚ÄôAPI, `index.php` pour l‚ÄôUI, services d√©di√©s pour auth/sessions.

---

## 8) Astuces & pi√®ges (et comment les anticiper)

- **401 sur add/reset malgr√© login** : v√©rifiez cookies/navigateur (m√™me origine), et que `SessionManager::demarrer()` est appel√© (il l‚Äôest).

- **CORS** : inutile en m√™me domaine ; si front s√©par√© ‚Üí ajouter les en-t√™tes CORS.

- **Prod** : ne jamais stocker des mots de passe en clair (utiliser `password_hash`, `password_verify`).

- **XML** : le parseur est strict ; bien envoyer `Content-Type: application/xml`.

- **S√©curit√© formulaire** : ajouter CSRF si vous passez en **POST HTML** (ici le POST est JSON c√¥t√© API et m√™me origine).


