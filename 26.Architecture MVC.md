## üéØ Atelier P√©dagogique : Architecture MVC

## Phase 1 ‚Äì Mini MVC sans Composer  + Router objet

### 0. Structure du projet

Arborescence propos√©e :

```text
php-mvc-produit/
  public/
    index.php
  src/
    Core/
      Router.php
    Controller/
      ProduitController.php
    Model/
      Produit.php
      ProduitRepository.php
  data/
    produits.json
  views/
    layout.php
    erreur.php
    produit/
      liste.php
      detail.php
      nouveau.php
```

---

### 1. Les donn√©es externalis√©es dans un fichier JSON

On va simuler la base avec un fichier `data/produits.json`.

Cr√©er le fichier **data/produits.json** :

```json
[
  {
    "id": 1,
    "nom": "Clavier m√©canique",
    "dateFabrication": "2024-01-15"
  },
  {
    "id": 2,
    "nom": "Souris gamer",
    "dateFabrication": "2024-02-10"
  },
  {
    "id": 3,
    "nom": "√âcran 27 pouces",
    "dateFabrication": "2023-12-05"
  }
]
```

> Id√©e p√©dagogique : ce fichier joue le r√¥le d‚Äôune petite table `produit` sans avoir encore MySQL ni PDO.

---

### 2. Entit√© `Produit`

Cr√©er le fichier **src/Model/Produit.php** :

```php
<?php
// src/Model/Produit.php

/**
 * Entit√© Produit.
 * Correspond exactement √† la structure de la "table" simul√©e dans produits.json.
 */
class Produit
{
    public int $id;
    public string $nom;
    public string $dateFabrication;

    public function __construct(int $id, string $nom, string $dateFabrication)
    {
        $this->id              = $id;
        $this->nom             = $nom;
        $this->dateFabrication = $dateFabrication;
    }

    /**
     * Convertit l'objet en tableau simple pour le r√©√©crire dans le JSON.
     */
    public function toArray(): array
    {
        return [
            'id'              => $this->id,
            'nom'             => $this->nom,
            'dateFabrication' => $this->dateFabrication,
        ];
    }
}
```

---

### 3. Repository avec lecture/√©criture JSON + ajout + suppression

Cr√©er le fichier **src/Model/ProduitRepository.php** :

```php
<?php
// src/Model/ProduitRepository.php

require_once __DIR__ . '/Produit.php';

/**
 * Repository responsable de l'acc√®s aux donn√©es des produits.
 * Ici, les donn√©es sont stock√©es dans un fichier JSON pour simuler une base.
 */
class ProduitRepository
{
    /** @var string chemin complet vers le fichier JSON */
    private string $jsonFile;

    public function __construct()
    {
        // On remonte de src/Model vers la racine du projet puis vers data/
        $this->jsonFile = dirname(__DIR__, 2) . '/data/produits.json';
    }

    /**
     * Lit le contenu du fichier JSON et retourne un tableau associatif.
     *
     * @return array<int, array<string, mixed>>
     */
    private function readData(): array
    {
        if (!file_exists($this->jsonFile)) {
            // Si le fichier n'existe pas, on retourne un tableau vide.
            return [];
        }

        $json = file_get_contents($this->jsonFile);

        if ($json === false || $json === '') {
            return [];
        }

        $data = json_decode($json, true);

        // Si le JSON est invalide, on √©vite de planter.
        if (!is_array($data)) {
            return [];
        }

        return $data;
    }

    /**
     * √âcrit un tableau associatif dans le fichier JSON.
     *
     * @param array<int, array<string, mixed>> $data
     */
    private function writeData(array $data): void
    {
        // Astuce : JSON_PRETTY_PRINT utile p√©dagogiquement pour ouvrir le fichier √† la main
        $json = json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);

        if ($json === false) {
            // En r√©el on loggerait l'erreur.
            return;
        }

        file_put_contents($this->jsonFile, $json);
    }

    /**
     * Retourne tous les produits sous forme d'objets Produit.
     *
     * @return Produit[]
     */
    public function findAll(): array
    {
        $rows     = $this->readData();
        $produits = [];

        foreach ($rows as $row) {
            $produits[] = new Produit(
                (int)($row['id'] ?? 0),
                (string)($row['nom'] ?? ''),
                (string)($row['dateFabrication'] ?? '')
            );
        }

        return $produits;
    }

    /**
     * Recherche un produit par son identifiant.
     * Retourne null si non trouv√©.
     */
    public function find(int $id): ?Produit
    {
        foreach ($this->findAll() as $produit) {
            if ($produit->id === $id) {
                return $produit;
            }
        }
        return null;
    }

    /**
     * Ajoute un nouveau produit dans le fichier JSON.
     * Retourne le produit cr√©√© (avec un nouvel id).
     */
    public function add(string $nom, string $dateFabrication): Produit
    {
        $data = $this->readData();

        // Astuce : g√©n√©rer un nouvel id = max existant + 1
        $maxId = 0;
        foreach ($data as $row) {
            $maxId = max($maxId, (int)($row['id'] ?? 0));
        }
        $newId = $maxId + 1;

        $produit = new Produit($newId, $nom, $dateFabrication);
        $data[]  = $produit->toArray();

        $this->writeData($data);

        return $produit;
    }

    /**
     * Supprime un produit par id.
     * Retourne true si au moins un produit a √©t√© supprim√©.
     */
    public function delete(int $id): bool
    {
        $data        = $this->readData();
        $newData     = [];
        $deleted     = false;

        foreach ($data as $row) {
            if ((int)($row['id'] ?? 0) === $id) {
                $deleted = true;
                // on ne recopie pas cette ligne -> suppression
                continue;
            }
            $newData[] = $row;
        }

        if ($deleted) {
            $this->writeData($newData);
        }

        return $deleted;
    }
}
```

---

### 4. Router objet s√©par√©

Ici on isole toute la logique de routage dans une classe `Router`.

Cr√©er le fichier **src/Core/Router.php** :

```php
<?php
// src/Core/Router.php

/**
 * Router minimaliste bas√© sur une table de routes.
 *
 * Objectifs p√©dagogiques :
 * - Centraliser la d√©finition des routes.
 * - Rendre les routes lisibles par les √©tudiants.
 * - D√©mystifier le lien "URL -> contr√¥leur -> m√©thode".
 */
class Router
{
    /**
     * @var array<string, array{controller: string, action: string}>
     * Exemple :
     *   'produit/index' => ['controller' => ProduitController::class, 'action' => 'index']
     */
    private array $routes = [];

    /**
     * D√©finir une route : nom logique + couple contr√¥leur/action.
     */
    public function add(string $name, string $controllerClass, string $action): void
    {
        $this->routes[$name] = [
            'controller' => $controllerClass,
            'action'     => $action,
        ];
    }

    /**
     * R√©sout une route √† partir de la cha√Æne fournie dans l'URL (param√®tre r).
     * Si la route n'existe pas, retourne null.
     */
    public function match(string $routeName): ?array
    {
        $routeName = trim($routeName, " \t\n\r\0\x0B/");

        if (!array_key_exists($routeName, $this->routes)) {
            return null;
        }

        return $this->routes[$routeName];
    }

    /**
     * Retourne le nom de route par d√©faut.
     * Utile pour centraliser la logique de "page d'accueil".
     */
    public function getDefaultRouteName(): string
    {
        return 'produit/index';
    }
}
```

> Astuce p√©dagogique : tu peux faire jouer les participants sur `getDefaultRouteName()` pour changer facilement la page d‚Äôaccueil, sans toucher au front controller.

---

### 5. Contr√¥leur `ProduitController` avec liste + d√©tail + ajout + suppression

Cr√©er le fichier **src/Controller/ProduitController.php** :

```php
<?php
// src/Controller/ProduitController.php

require_once __DIR__ . '/../Model/ProduitRepository.php';

/**
 * Contr√¥leur responsable de la logique Produits.
 *
 * Actions disponibles (Phase 1) :
 * - index()   : liste des produits
 * - show()    : d√©tail d'un produit
 * - nouveau() : formulaire d'ajout
 * - ajouter() : traitement du POST d'ajout
 * - supprimer(): suppression d'un produit
 */
class ProduitController
{
    private ProduitRepository $repository;

    public function __construct()
    {
        $this->repository = new ProduitRepository();
    }

    /**
     * Liste tous les produits.
     * Route : produit/index
     */
    public function index(): void
    {
        $produits = $this->repository->findAll();
        require __DIR__ . '/../../views/produit/liste.php';
    }

    /**
     * Affiche le d√©tail d'un produit.
     * Route : produit/show&id=1
     */
    public function show(): void
    {
        $id = isset($_GET['id']) ? (int) $_GET['id'] : 0;

        if ($id <= 0) {
            $messageErreur = "Identifiant de produit invalide.";
            require __DIR__ . '/../../views/erreur.php';
            return;
        }

        $produit = $this->repository->find($id);

        if ($produit === null) {
            $messageErreur = "Produit introuvable (id = {$id}).";
            require __DIR__ . '/../../views/erreur.php';
            return;
        }

        require __DIR__ . '/../../views/produit/detail.php';
    }

    /**
     * Affiche un petit formulaire d'ajout.
     * Route : produit/nouveau
     */
    public function nouveau(): void
    {
        require __DIR__ . '/../../views/produit/nouveau.php';
    }

    /**
     * Traite le formulaire d'ajout (m√©thode POST).
     * Route : produit/ajouter
     */
    public function ajouter(): void
    {
        // On r√©cup√®re les champs du formulaire
        $nom             = trim($_POST['nom'] ?? '');
        $dateFabrication = trim($_POST['dateFabrication'] ?? '');

        // Validation tr√®s simple pour la p√©dagogie
        if ($nom === '' || $dateFabrication === '') {
            $messageErreur = "Le nom et la date de fabrication sont obligatoires.";
            require __DIR__ . '/../../views/erreur.php';
            return;
        }

        // Ajout via le repository (qui √©crit dans le JSON)
        $this->repository->add($nom, $dateFabrication);

        // Redirection simple vers la liste
        header('Location: index.php?r=produit/index');
        exit;
    }

    /**
     * Supprime un produit.
     * Route : produit/supprimer&id=1
     */
    public function supprimer(): void
    {
        $id = isset($_GET['id']) ? (int) $_GET['id'] : 0;

        if ($id <= 0) {
            $messageErreur = "Identifiant de produit invalide pour la suppression.";
            require __DIR__ . '/../../views/erreur.php';
            return;
        }

        $ok = $this->repository->delete($id);

        if (!$ok) {
            $messageErreur = "Aucun produit trouv√© √† supprimer (id = {$id}).";
            require __DIR__ . '/../../views/erreur.php';
            return;
        }

        // Redirection vers la liste apr√®s suppression
        header('Location: index.php?r=produit/index');
        exit;
    }
}
```

---

### 6. Vues

#### 6.1. Layout

Cr√©er le fichier **views/layout.php** :

```php
<?php
// views/layout.php
?>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title><?= htmlspecialchars($title ?? 'Mini MVC Produits') ?></title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        header { margin-bottom: 1.5rem; }
        nav a { margin-right: 1rem; }
        table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
        th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
        .error { color: red; font-weight: bold; }
        form div { margin-bottom: 0.5rem; }
    </style>
</head>
<body>
    <header>
        <h1>Mini MVC Produits</h1>
        <nav>
            <a href="index.php?r=produit/index">Liste des produits</a>
            <a href="index.php?r=produit/nouveau">Nouveau produit</a>
        </nav>
        <hr>
    </header>

    <main>
        <?= $content ?? '' ?>
    </main>
</body>
</html>
```

---

#### 6.2. Vue liste avec actions voir + supprimer

Cr√©er le fichier **views/produit/liste.php** :

```php
<?php
// views/produit/liste.php
// Variable attendue : $produits

$title = 'Liste des produits';

ob_start();
?>
<h2>Liste des produits</h2>

<?php if (empty($produits)): ?>
    <p>Aucun produit trouv√©.</p>
<?php else: ?>
    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>Nom</th>
            <th>Date de fabrication</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <?php foreach ($produits as $produit): ?>
            <tr>
                <td><?= htmlspecialchars($produit->id) ?></td>
                <td><?= htmlspecialchars($produit->nom) ?></td>
                <td><?= htmlspecialchars($produit->dateFabrication) ?></td>
                <td>
                    <a href="index.php?r=produit/show&id=<?= urlencode($produit->id) ?>">Voir</a>
                    |
                    <a href="index.php?r=produit/supprimer&id=<?= urlencode($produit->id) ?>"
                       onclick="return confirm('Supprimer ce produit ?');">
                        Supprimer
                    </a>
                </td>
            </tr>
        <?php endforeach; ?>
        </tbody>
    </table>
<?php endif; ?>
<?php
$content = ob_get_clean();
require __DIR__ . '/../layout.php';
```

---

#### 6.3. Vue d√©tail

Cr√©er le fichier **views/produit/detail.php** :

```php
<?php
// views/produit/detail.php
// Variable attendue : $produit

$title = 'D√©tail du produit #' . $produit->id;

ob_start();
?>
<h2>D√©tail du produit</h2>

<ul>
    <li><strong>ID :</strong> <?= htmlspecialchars($produit->id) ?></li>
    <li><strong>Nom :</strong> <?= htmlspecialchars($produit->nom) ?></li>
    <li><strong>Date de fabrication :</strong> <?= htmlspecialchars($produit->dateFabrication) ?></li>
</ul>

<p>
    <a href="index.php?r=produit/index">Retour √† la liste</a>
</p>
<?php
$content = ob_get_clean();
require __DIR__ . '/../layout.php';
```

---

#### 6.4. Vue formulaire d‚Äôajout

Cr√©er le fichier **views/produit/nouveau.php** :

```php
<?php
// views/produit/nouveau.php

$title = 'Nouveau produit';

ob_start();
?>
<h2>Ajouter un nouveau produit</h2>

<form method="post" action="index.php?r=produit/ajouter">
    <div>
        <label for="nom">Nom :</label><br>
        <input type="text" name="nom" id="nom" required>
    </div>
    <div>
        <label for="dateFabrication">Date de fabrication (AAAA-MM-JJ) :</label><br>
        <input type="date" name="dateFabrication" id="dateFabrication" required>
    </div>
    <div>
        <button type="submit">Enregistrer</button>
    </div>
</form>
<?php
$content = ob_get_clean();
require __DIR__ . '/../layout.php';
```

---

#### 6.5. Vue erreur

Cr√©er le fichier **views/erreur.php** :

```php
<?php
// views/erreur.php
// Variable attendue : $messageErreur

$title = 'Erreur';

ob_start();
?>
<h2>Erreur</h2>
<p class="error"><?= htmlspecialchars($messageErreur ?? 'Une erreur est survenue.') ?></p>

<p>
    <a href="index.php?r=produit/index">Retour √† la liste des produits</a>
</p>
<?php
$content = ob_get_clean();
require __DIR__ . '/layout.php';
```

---

### 7. Front controller qui utilise la classe Router

Cr√©er le fichier **public/index.php** :

```php
<?php
// public/index.php
//
// Front controller.
// Objectif : tout passe par ce fichier, qui d√©l√®gue √† un Router objet.

require_once __DIR__ . '/../src/Core/Router.php';
require_once __DIR__ . '/../src/Controller/ProduitController.php';

// 1) On instancie le router
$router = new Router();

// 2) On enregistre les routes disponibles
$router->add('produit/index',     ProduitController::class, 'index');
$router->add('produit/show',      ProduitController::class, 'show');
$router->add('produit/nouveau',   ProduitController::class, 'nouveau');
$router->add('produit/ajouter',   ProduitController::class, 'ajouter');
$router->add('produit/supprimer', ProduitController::class, 'supprimer');

// 3) On r√©cup√®re la route demand√©e dans l'URL
$routeName = $_GET['r'] ?? $router->getDefaultRouteName();

// 4) On demande au router de r√©soudre la route
$routeConfig = $router->match($routeName);

if ($routeConfig === null) {
    // Route inconnue -> 404 simple
    http_response_code(404);
    $messageErreur = "Route introuvable : " . htmlspecialchars($routeName);
    require __DIR__ . '/../views/erreur.php';
    exit;
}

$controllerClass = $routeConfig['controller'];
$actionName      = $routeConfig['action'];

// 5) V√©rifications de base pour √©viter les erreurs silencieuses
if (!class_exists($controllerClass)) {
    http_response_code(500);
    $messageErreur = "Contr√¥leur introuvable : " . htmlspecialchars($controllerClass);
    require __DIR__ . '/../views/erreur.php';
    exit;
}

$controller = new $controllerClass();

if (!method_exists($controller, $actionName)) {
    http_response_code(500);
    $messageErreur = "Action introuvable : "
                   . htmlspecialchars($actionName)
                   . " sur le contr√¥leur "
                   . htmlspecialchars($controllerClass);
    require __DIR__ . '/../views/erreur.php';
    exit;
}

// 6) Appel de l'action (le contr√¥leur se charge du reste)
$controller->$actionName();
```

---

### 8. Test rapide

Depuis la racine du projet :

Tr√®s bien, on reprend **depuis le d√©but** de l‚Äôint√©gration Composer, proprement, c**almement, sans b√¢clage üòÑ  **
On part du principe que **ta Phase 1 JSON + Router objet fonctionne d√©j√†**.

Je vais structurer √ßa en √©tapes tr√®s nettes :

1. Rappel de l‚Äô√©tat actuel du projet (avant Composer)

2. Initialisation de Composer dans le projet

3. Configuration de l‚Äôautoload PSR-4

4. Ajout des `namespace` dans les classes (Core, Model, Controller)

5. Modification de `public/index.php` pour utiliser `vendor/autoload.php`

6. V√©rification et tests

---

## Phase 2  : Etat du projet AVANT Composer

On suppose que tu as d√©j√† un projet qui ressemble √† √ßa :

```text
php-mvc-produit/
  public/
    index.php
  src/
    Core/
      Router.php
    Controller/
      ProduitController.php
    Model/
      Produit.php
      ProduitRepository.php
  data/
    produits.json
  views/
    layout.php
    erreur.php
    produit/
      liste.php
      detail.php
      nouveau.php
```

- Les classes sont **sans namespace**.

- Tu as des `require_once` dans les fichiers PHP.

- `public/index.php` inclut manuellement le router et le contr√¥leur.

On va transformer √ßa en un projet **pilot√© par Composer**.

---

## 1. Initialiser Composer dans le projet

üí° Objectif : dire √† Composer ‚Äúce dossier est un projet PHP‚Äù et cr√©er `composer.json`.

Ouvre un terminal dans la racine du projet :

```bash
cd C:\<dossier racine>   # ou le chemin √©quivalent chez toi
```

Lance :

```bash
composer init
```

Tu peux r√©pondre simplement :

- Package name : `bechir/mvc-produit`

- Description : `Mini MVC p√©dagogique avec produits`

- Author : `Bechir <email>` (optionnel)

- Minimum Stability : laisse par d√©faut

- Type : laisse vide

- License : `MIT` (ou autre)

- Confirme la g√©n√©ration du fichier.

Composer cr√©e un fichier **composer.json** minimal.

Nous allons le modifier tout de suite pour ajouter l‚Äôautoload.

---

## 2. Configurer l‚Äôautoload PSR-4 dans composer.json

üéØ Objectif : dire √† Composer :

> ‚ÄúQuand tu vois une classe `App\QuelqueChose\Truc`, va chercher le code dans `src/`.‚Äù

On va utiliser le namespace racine `App\`.

Cr√©er le fichier **composer.json** (ou remplace son contenu actuel par ceci) :

```json
{
    "name": "bechir/mvc-produit",
    "description": "Mini MVC pedagogique avec produits",
    "type": "project",
    "autoload": {
        "psr-4": {
            "App\\": "src/"
        }
    },
    "require": {
    }
}
```

- La cl√© `"autoload"` est le point important ici.

- `"App\\": "src/"` signifie :  
  `App\X\Y\Z` ‚Üí fichier dans `src/X/Y/Z.php`

Ensuite, **tr√®s important** : demander √† Composer de g√©n√©rer l‚Äôautoload.

Dans le terminal :

```bash
composer dump-autoload
```

R√©sultat important :

- Un dossier `vendor/` appara√Æt.

- Un fichier `vendor/autoload.php` est cr√©√© ‚Üí c‚Äôest lui qu‚Äôon va inclure dans `public/index.php`.

---

## 3. Ajouter des namespaces dans les classes

Maintenant qu‚Äôon a dit √† Composer ‚Äúle code App\ est dans src/‚Äù, on doit **nommer** nos classes en cons√©quence.

### R√®gle :

- Fichiers dans `src/Core` ‚Üí namespace `App\Core`

- Fichiers dans `src/Model` ‚Üí namespace `App\Model`

- Fichiers dans `src/Controller` ‚Üí namespace `App\Controller`

Ensuite, on n‚Äôutilisera plus `require_once` entre ces fichiers : ce sera l‚Äôautoload qui fera le boulot.

---

### 3.1. Classe Router (Core)

On lui donne `namespace App\Core;`.

Cr√©er le fichier **src/Core/Router.php** (version Composer) :

```php
<?php
namespace App\Core;

/**
 * Router minimaliste bas√© sur une table de routes.
 *
 * R√¥le :
 *  - Enregistrer les routes (nom logique -> contr√¥leur + action).
 *  - Retrouver la configuration d'une route √† partir de son nom.
 *  - Fournir la route par d√©faut.
 */
class Router
{
    /**
     * @var array<string, array{controller: string, action: string}>
     */
    private array $routes = [];

    /**
     * Ajoute une route dans la table.
     *
     * Exemple d'appel :
     *   $router->add('produit/index', ProduitController::class, 'index');
     */
    public function add(string $name, string $controllerClass, string $action): void
    {
        $this->routes[$name] = [
            'controller' => $controllerClass,
            'action'     => $action,
        ];
    }

    /**
     * Tente de retrouver la configuration d'une route.
     * Retourne null si la route n'existe pas.
     */
    public function match(string $routeName): ?array
    {
        // On nettoie un peu la route (enl√®ve les / en d√©but/fin)
        $routeName = trim($routeName, " \t\n\r\0\x0B/");

        return $this->routes[$routeName] ?? null;
    }

    /**
     * Nom de la route par d√©faut (page d'accueil).
     */
    public function getDefaultRouteName(): string
    {
        return 'produit/index';
    }
}
```

> Note : plus de `require_once` ici, juste le namespace.

---

### 3.2. Entit√© Produit (Model)

Cr√©er le fichier **src/Model/Produit.php** :

```php
<?php
namespace App\Model;

/**
 * Entit√© Produit.
 *
 * Correspond aux enregistrements du fichier JSON (et plus tard √† une table MySQL).
 */
class Produit
{
    public int $id;
    public string $nom;
    public string $dateFabrication;

    public function __construct(int $id, string $nom, string $dateFabrication)
    {
        $this->id              = $id;
        $this->nom             = $nom;
        $this->dateFabrication = $dateFabrication;
    }

    /**
     * Transforme l'objet en tableau simple, pour stockage JSON.
     */
    public function toArray(): array
    {
        return [
            'id'              => $this->id,
            'nom'             => $this->nom,
            'dateFabrication' => $this->dateFabrication,
        ];
    }
}
```

---

### 3.3. Repository ProduitRepository (Model)

Ici on utilise √† la fois le namespace `App\Model` et la classe `Produit`.

Cr√©er le fichier **src/Model/ProduitRepository.php** :

```php
<?php
namespace App\Model;

use App\Model\Produit;

/**
 * ProduitRepository
 *
 * R√¥le :
 *  - Lire et √©crire les produits dans un fichier JSON.
 *  - Fournir des m√©thodes m√©tiers (findAll, find, add, delete).
 */
class ProduitRepository
{
    /** @var string Chemin complet vers le fichier JSON simulant la base */
    private string $jsonFile;

    public function __construct()
    {
        // __DIR__ = src/Model
        // dirname(__DIR__, 2) = remonte de "Model" -> "src" -> racine du projet
        // On ajoute /data/produits.json
        $this->jsonFile = dirname(__DIR__, 2) . '/data/produits.json';
    }

    /**
     * Lit le JSON et renvoie un tableau associatif brut.
     *
     * @return array<int, array<string, mixed>>
     */
    private function readData(): array
    {
        if (!file_exists($this->jsonFile)) {
            return [];
        }

        $json = file_get_contents($this->jsonFile);
        if ($json === false || $json === '') {
            return [];
        }

        $data = json_decode($json, true);
        if (!is_array($data)) {
            return [];
        }

        return $data;
    }

    /**
     * √âcrit les donn√©es dans le fichier JSON.
     *
     * @param array<int, array<string, mixed>> $data
     */
    private function writeData(array $data): void
    {
        $json = json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);
        if ($json === false) {
            return;
        }

        file_put_contents($this->jsonFile, $json);
    }

    /**
     * Retourne tous les produits sous forme d'objets Produit.
     *
     * @return Produit[]
     */
    public function findAll(): array
    {
        $rows     = $this->readData();
        $produits = [];

        foreach ($rows as $row) {
            $produits[] = new Produit(
                (int)($row['id'] ?? 0),
                (string)($row['nom'] ?? ''),
                (string)($row['dateFabrication'] ?? '')
            );
        }

        return $produits;
    }

    /**
     * Recherche un produit par son identifiant.
     */
    public function find(int $id): ?Produit
    {
        foreach ($this->findAll() as $produit) {
            if ($produit->id === $id) {
                return $produit;
            }
        }

        return null;
    }

    /**
     * Ajoute un nouveau produit et le sauvegarde dans le JSON.
     */
    public function add(string $nom, string $dateFabrication): Produit
    {
        $data = $this->readData();

        // G√©n√©ration d'un nouvel id simple : max existant + 1
        $maxId = 0;
        foreach ($data as $row) {
            $maxId = max($maxId, (int)($row['id'] ?? 0));
        }
        $newId = $maxId + 1;

        $produit = new Produit($newId, $nom, $dateFabrication);
        $data[]  = $produit->toArray();

        $this->writeData($data);

        return $produit;
    }

    /**
     * Supprime un produit par son id.
     */
    public function delete(int $id): bool
    {
        $data    = $this->readData();
        $newData = [];
        $deleted = false;

        foreach ($data as $row) {
            if ((int)($row['id'] ?? 0) === $id) {
                $deleted = true;
                continue;
            }
            $newData[] = $row;
        }

        if ($deleted) {
            $this->writeData($newData);
        }

        return $deleted;
    }
}
```

---

### 3.4. Contr√¥leur ProduitController (Controller)

Ici on ajoute :

- `namespace App\Controller;`

- `use App\Model\ProduitRepository;`

Cr√©er le fichier **src/Controller/ProduitController.php** :

```php
<?php
namespace App\Controller;

use App\Model\ProduitRepository;

/**
 * ProduitController
 *
 * R√¥le :
 *  - R√©cup√©rer la requ√™te (via $_GET/$_POST).
 *  - Appeler le repository pour manipuler les donn√©es.
 *  - Choisir la vue √† afficher.
 */
class ProduitController
{
    private ProduitRepository $repository;

    public function __construct()
    {
        $this->repository = new ProduitRepository();
    }

    /**
     * Affiche la liste des produits.
     * Route : produit/index
     */
    public function index(): void
    {
        $produits = $this->repository->findAll();

        // On charge la vue de liste.
        // dirname(__DIR__, 2) = racine du projet
        require dirname(__DIR__, 2) . '/views/produit/liste.php';
    }

    /**
     * Affiche le d√©tail d'un produit.
     * Route : produit/show&id=1
     */
    public function show(): void
    {
        $id = isset($_GET['id']) ? (int) $_GET['id'] : 0;

        if ($id <= 0) {
            $messageErreur = "Identifiant de produit invalide.";
            require dirname(__DIR__, 2) . '/views/erreur.php';
            return;
        }

        $produit = $this->repository->find($id);

        if ($produit === null) {
            $messageErreur = "Produit introuvable (id = {$id}).";
            require dirname(__DIR__, 2) . '/views/erreur.php';
            return;
        }

        require dirname(__DIR__, 2) . '/views/produit/detail.php';
    }

    /**
     * Affiche le formulaire d'ajout.
     * Route : produit/nouveau
     */
    public function nouveau(): void
    {
        require dirname(__DIR__, 2) . '/views/produit/nouveau.php';
    }

    /**
     * Traite le formulaire d'ajout (POST).
     * Route : produit/ajouter
     */
    public function ajouter(): void
    {
        $nom             = trim($_POST['nom'] ?? '');
        $dateFabrication = trim($_POST['dateFabrication'] ?? '');

        if ($nom === '' || $dateFabrication === '') {
            $messageErreur = "Le nom et la date de fabrication sont obligatoires.";
            require dirname(__DIR__, 2) . '/views/erreur.php';
            return;
        }

        $this->repository->add($nom, $dateFabrication);

        header('Location: index.php?r=produit/index');
        exit;
    }

    /**
     * Supprime un produit.
     * Route : produit/supprimer&id=1
     */
    public function supprimer(): void
    {
        $id = isset($_GET['id']) ? (int) $_GET['id'] : 0;

        if ($id <= 0) {
            $messageErreur = "Identifiant de produit invalide pour la suppression.";
            require dirname(__DIR__, 2) . '/views/erreur.php';
            return;
        }

        $ok = $this->repository->delete($id);

        if (!$ok) {
            $messageErreur = "Aucun produit trouv√© √† supprimer (id = {$id}).";
            require dirname(__DIR__, 2) . '/views/erreur.php';
            return;
        }

        header('Location: index.php?r=produit/index');
        exit;
    }
}
```

üëâ Remarque : dans ce contr√¥leur, on ne fait plus **aucun require de classes** (Router, Produit, etc.). Tout est g√©r√© par **l‚Äôautoload de Composer**.

Les vues `views/*.php` restent **sans namespace**, elles ne changent pas.

---

## 4. Adapter `public/index.php` pour utiliser Composer

C‚Äôest **le point cl√©** pour Composer :

1. On inclut `vendor/autoload.php`.

2. On utilise des `use` pour importer `Router` et `ProduitController`.

3. Plus AUCUN `require_once` pour les classes de `src/`.

Cr√©er le fichier **public/index.php** :

```php
<?php
// public/index.php
//
// Front controller de l'application.
// R√¥le :
//  - Charger l'autoload de Composer.
//  - Cr√©er le Router.
//  - Enregistrer les routes.
//  - R√©soudre la route demand√©e.
//  - Appeler le bon contr√¥leur et la bonne action.

require_once __DIR__ . '/../vendor/autoload.php';

use App\Core\Router;
use App\Controller\ProduitController;

// 1) On instancie le router (classe App\Core\Router)
$router = new Router();

// 2) On enregistre les routes disponibles
$router->add('produit/index',     ProduitController::class, 'index');
$router->add('produit/show',      ProduitController::class, 'show');
$router->add('produit/nouveau',   ProduitController::class, 'nouveau');
$router->add('produit/ajouter',   ProduitController::class, 'ajouter');
$router->add('produit/supprimer', ProduitController::class, 'supprimer');

// 3) On r√©cup√®re la route demand√©e dans l'URL : ?r=...
$routeName = $_GET['r'] ?? $router->getDefaultRouteName();

// 4) On demande au router de nous donner la config de cette route
$routeConfig = $router->match($routeName);

if ($routeConfig === null) {
    http_response_code(404);
    $messageErreur = "Route introuvable : " . htmlspecialchars($routeName);
    require __DIR__ . '/../views/erreur.php';
    exit;
}

$controllerClass = $routeConfig['controller']; // ex: App\Controller\ProduitController
$actionName      = $routeConfig['action'];     // ex: 'index'

// 5) V√©rifications
if (!class_exists($controllerClass)) {
    http_response_code(500);
    $messageErreur = "Contr√¥leur introuvable : " . htmlspecialchars($controllerClass);
    require __DIR__ . '/../views/erreur.php';
    exit;
}

$controller = new $controllerClass();

if (!method_exists($controller, $actionName)) {
    http_response_code(500);
    $messageErreur = "Action introuvable : "
                   . htmlspecialchars($actionName)
                   . " sur le contr√¥leur "
                   . htmlspecialchars($controllerClass);
    require __DIR__ . '/../views/erreur.php';
    exit;
}

// 6) On appelle l'action du contr√¥leur
$controller->$actionName();
```

> Ligne essentielle :  
> `require_once __DIR__ . '/../vendor/autoload.php';`  
> ‚Üí c‚Äôest ce fichier qui d√©clenche le m√©canisme d‚Äôautoload Composer.

---

## 5. Tester que tout fonctionne avec Composer

Dans le terminal, √† la racine du projet :

```bash
http://localhost:8000/dossier/index.php
```

remplacer le JSON par MySQL/PDO**, sans casser ton MVC ni ton router.

On va faire √ßa proprement :

1. Cr√©er la base + table MySQL.

2. Ajouter une petite classe `Database` (PDO centralis√©).

3. R√©√©crire `ProduitRepository` en PDO (findAll, find, add, delete).

4. V√©rifier que **le contr√¥leur et le router ne changent pas** (c‚Äôest le but).

--

## 1. Pr√©parer MySQL : base, utilisateur, table

On part sur tes param√®tres :

- host : `localhost`

- user : `bechir`

- pass : `abc`

- base : `entreprise`

- table : `produit(id, nom, datefabrication)`

Connecte-toi au shell MySQL (par exemple) :

```bash
mysql -u root -p
```

Ensuite, ex√©cute ces commandes SQL :

```sql
-- 1) Cr√©er la base si elle n'existe pas
CREATE DATABASE IF NOT EXISTS entreprise
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;

-- 2) Cr√©er l'utilisateur (si tu ne l'as pas d√©j√†)
CREATE USER IF NOT EXISTS 'bechir'@'localhost'
  IDENTIFIED BY 'abc';

-- 3) Donner les droits sur la base "entreprise"
GRANT ALL PRIVILEGES ON entreprise.* TO 'bechir'@'localhost';

FLUSH PRIVILEGES;

-- 4) Utiliser la base
USE entreprise;

-- 5) Cr√©er la table "produit"
DROP TABLE IF EXISTS produit;

CREATE TABLE produit (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nom VARCHAR(255) NOT NULL,
  datefabrication DATE NOT NULL
);

-- 6) Ins√©rer quelques donn√©es de test
INSERT INTO produit (nom, datefabrication) VALUES
  ('Clavier m√©canique', '2024-01-15'),
  ('Souris gamer', '2024-02-10'),
  ('√âcran 27 pouces', '2023-12-05');
```

> Remarque : en base j‚Äôutilise `datefabrication` (tout en minuscules) et dans l‚Äôentit√© PHP on garde `dateFabrication`.  
> Le mapping se fait dans le repository.

---

## 2. Ajouter une classe `Database` pour g√©rer PDO

But p√©dagogique :

- Centraliser la cr√©ation de `PDO`.

- Factoriser le DSN, user, mot de passe.

- Activer le mode exception + UTF-8.

On met √ßa dans `src/Core/Database.php` pour pouvoir le r√©utiliser plus tard (auth, etc.).

Cr√©er le fichier **src/Core/Database.php** :

```php
<?php
namespace App\Core;

use PDO;
use PDOException;

/**
 * Classe utilitaire pour centraliser la connexion PDO.
 *
 * Id√©e cl√© :
 *  - Une seule responsabilit√© : fournir un objet PDO configur√©.
 *  - Toute la config (host, dbname, user, pass) est ici.
 */
class Database
{
    /**
     * Retourne une instance de PDO connect√©e √† MySQL.
     *
     * @return PDO
     * @throws PDOException si la connexion √©choue.
     */
    public static function getConnection(): PDO
    {
        // Param√®tres de connexion (ici en dur pour la p√©dagogie).
        // Plus tard, on pourra les d√©placer dans un fichier de config.
        $host     = 'localhost';
        $dbname   = 'entreprise';
        $username = 'bechir';
        $password = 'abc';
        $charset  = 'utf8mb4';

        // DSN (Data Source Name) pour MySQL
        $dsn = "mysql:host={$host};dbname={$dbname};charset={$charset}";

        // Options PDO pour :
        //  - avoir des exceptions en cas d'erreur
        //  - r√©cup√©rer les r√©sultats en tableaux associatifs par d√©faut
        $options = [
            PDO::ATTR_ERRMODE            => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        ];

        return new PDO($dsn, $username, $password, $options);
    }
}
```

> √Ä retenir pour l‚Äôatelier : tout ce qui est ‚Äúconnexion‚Äù se trouve dans **une seule classe** ‚Üí plus simple √† maintenir et √† tester.

---

## 3. R√©√©crire `ProduitRepository` pour utiliser PDO au lieu du JSON

Ici on :

- supprime toute la logique JSON (readData/writeData),

- injecte un `PDO` dans la classe,

- impl√©mente `findAll`, `find`, `add`, `delete` en SQL.

Cr√©er le fichier **src/Model/ProduitRepository.php** (en rempla√ßant l‚Äôancien JSON) :

```php
<?php
namespace App\Model;

use App\Core\Database;
use App.Model\Produit;
use PDO;

/**
 * ProduitRepository (version PDO + MySQL)
 *
 * R√¥le :
 *  - Offrir une API m√©tier pour manipuler les produits.
 *  - D√©l√©guer les requ√™tes SQL √† PDO.
 *
 * Table cible :
 *  - entreprise.produit (id, nom, datefabrication)
 */
class ProduitRepository
{
    /** @var PDO Connexion PDO inject√©e via Database::getConnection() */
    private PDO $pdo;

    public function __construct()
    {
        // On r√©cup√®re une connexion PDO depuis la classe Database.
        // Id√©e p√©dagogique : centraliser la config dans un seul endroit.
        $this->pdo = Database::getConnection();
    }

    /**
     * Retourne tous les produits sous forme d'objets Produit.
     *
     * @return Produit[]
     */
    public function findAll(): array
    {
        // Requ√™te SQL simple : on r√©cup√®re toutes les colonnes.
        $sql = "SELECT id, nom, datefabrication FROM produit";

        $stmt = $this->pdo->query($sql);

        $produits = [];

        // On it√®re sur chaque ligne et on les transforme en objets Produit.
        while ($row = $stmt->fetch()) {
            $produits[] = new Produit(
                (int) $row['id'],
                (string) $row['nom'],
                (string) $row['datefabrication']  // mapping vers la propri√©t√© dateFabrication
            );
        }

        return $produits;
    }

    /**
     * Recherche un produit par son identifiant.
     * Retourne null si aucun produit trouv√©.
     */
    public function find(int $id): ?Produit
    {
        $sql = "SELECT id, nom, datefabrication FROM produit WHERE id = :id";

        $stmt = $this->pdo->prepare($sql);
        $stmt->execute(['id' => $id]);

        $row = $stmt->fetch();

        if ($row === false) {
            return null;
        }

        return new Produit(
            (int) $row['id'],
            (string) $row['nom'],
            (string) $row['datefabrication']
        );
    }

    /**
     * Ajoute un nouveau produit dans la table.
     *
     * @return Produit Le produit cr√©√© avec son id auto-incr√©ment√©.
     */
    public function add(string $nom, string $dateFabrication): Produit
    {
        $sql = "INSERT INTO produit (nom, datefabrication)
                VALUES (:nom, :datefabrication)";

        $stmt = $this->pdo->prepare($sql);

        $stmt->execute([
            'nom'             => $nom,
            'datefabrication' => $dateFabrication,
        ]);

        // On r√©cup√®re l'id g√©n√©r√© par AUTO_INCREMENT
        $id = (int) $this->pdo->lastInsertId();

        return new Produit($id, $nom, $dateFabrication);
    }

    /**
     * Supprime un produit par son id.
     * Retourne true si au moins une ligne a √©t√© supprim√©e.
     */
    public function delete(int $id): bool
    {
        $sql = "DELETE FROM produit WHERE id = :id";

        $stmt = $this->pdo->prepare($sql);
        $stmt->execute(['id' => $id]);

        // rowCount() donne le nombre de lignes impact√©es par la requ√™te.
        return $stmt->rowCount() > 0;
    }
}
```

- `query()` pour les requ√™tes **sans param√®tres** (ici `findAll`).

- `prepare()` + `execute()` pour les requ√™tes **avec param√®tres** (`find`, `add`, `delete`) ‚Üí protection contre injection SQL.

- `lastInsertId()` pour r√©cup√©rer l‚Äôid apr√®s un `INSERT`.

- `rowCount()` pour savoir si un `DELETE` a bien supprim√© quelque chose.

---

## 4. Entit√© `Produit` : mapping simple

Tu peux garder ton entit√© telle que d√©j√† d√©finie, par exemple :

Cr√©er le fichier **src/Model/Produit.php** (si besoin de rappel) :

```php
<?php
namespace App.Model;

/**
 * Entit√© Produit.
 *
 * Correspond √† la table "produit" :
 *  - id
 *  - nom
 *  - datefabrication (en base) -> propri√©t√© dateFabrication en PHP
 */
class Produit
{
    public int $id;
    public string $nom;
    public string $dateFabrication;

    public function __construct(int $id, string $nom, string $dateFabrication)
    {
        $this->id              = $id;
        $this->nom             = $nom;
        $this->dateFabrication = $dateFabrication;
    }

    /**
     * Utile si un jour tu veux retransformer l'objet vers un tableau.
     */
    public function toArray(): array
    {
        return [
            'id'              => $this->id,
            'nom'             => $this->nom,
            'dateFabrication' => $this->dateFabrication,
        ];
    }
}
```

> On accepte une petite diff√©rence de casse entre `datefabrication` (SQL) et `dateFabrication` (PHP)  
> ‚Üí c‚Äôest le repository qui g√®re la conversion.

---

## 5. Contr√¥leur & router : **aucune modification**

C‚Äôest justement un des messages p√©dagogiques importants du MVC :

- Tu viens de **changer compl√®tement** le m√©canisme d‚Äôacc√®s aux donn√©es (JSON ‚Üí PDO/MySQL),

- mais **le contr√¥leur n‚Äôa pas boug√©** : il appelle toujours `ProduitRepository` avec les m√™mes m√©thodes.

Si ton `ProduitController` ressemble √† ce qu‚Äôon avait en Phase 2 (autoloader + namespaces), tu n‚Äôas rien √† changer.

---

## 6. Test de l‚Äôapplication avec PDO

1. V√©rifie que l‚Äôextension `pdo_mysql` est bien activ√©e dans ton `php.ini`.  
   (tu l‚Äôas probablement d√©j√† activ√©e pour Composer).

2. Reg√©n√®re l‚Äôautoload (par principe, apr√®s ajout de `Database.php`) :

```bash
cd C:\www\mvc2
composer dump-autoload
```

3. Lance ton serveur (exemple) :

```bash
php -S localhost:8000 -t public
```

4. Teste :
- `http://localhost:8000/index.php`  
  ‚Üí doit afficher la liste des produits issus de MySQL.

- `http://localhost:8000/index.php?r=produit/nouveau`  
  ‚Üí formulaire d‚Äôajout (INSERT).

- `http://localhost:8000/index.php?r=produit/show&id=1`  
  ‚Üí d√©tail du produit avec `id = 1`.

- `http://localhost:8000/index.php?r=produit/supprimer&id=1`  
  ‚Üí supprime en base, puis redirection vers la liste.

## Phase 4 : Ajout de couche d'authentification

1. Base MySQL : table `user`

Dans MySQL (toujours sur la base `entreprise`) :

```sql
USE entreprise;

DROP TABLE IF EXISTS user;

CREATE TABLE user (
  id   INT AUTO_INCREMENT PRIMARY KEY,
  login VARCHAR(100) NOT NULL UNIQUE,
  pass  VARCHAR(255) NOT NULL,
  role  VARCHAR(50)  NOT NULL
);

INSERT INTO user (login, pass, role) VALUES
  ('admin', 'admin123', 'admin'),
  ('user',  'user123',  'user');
```

> D√©mo p√©dagogique : mot de passe en clair pour que les stagiaires ‚Äúvoient‚Äù ce qu‚Äôil se passe.  
> Tu pourras ensuite faire une variante avec `password_hash()/password_verify()`.

---

## 2. Entit√© `User`

Cr√©er le fichier **src/Model/User.php** :

```php
<?php
namespace App\Model;

/**
 * Entit√© User.
 * Correspond √† la table "user" en base.
 */
class User
{
    public int $id;
    public string $login;
    public string $pass;
    public string $role;

    public function __construct(int $id, string $login, string $pass, string $role)
    {
        $this->id    = $id;
        $this->login = $login;
        $this->pass  = $pass;
        $this->role  = $role;
    }
}
```

---

## 3. UserRepository (acc√®s √† la table `user` via PDO)

Cr√©er le fichier **src/Model/UserRepository.php** :

```php
<?php
namespace App.Model;

use App\Core.Database;
use PDO;

/**
 * UserRepository
 *
 * R√¥le :
 *  - R√©cup√©rer un utilisateur en base.
 *  - Centraliser l'acc√®s √† la table "user".
 */
class UserRepository
{
    private PDO $pdo;

    public function __construct()
    {
        // On r√©utilise la classe Database d√©j√† utilis√©e pour ProduitRepository.
        $this->pdo = Database::getConnection();
    }

    /**
     * Recherche un utilisateur par son login.
     * Retourne null si aucun utilisateur trouv√©.
     */
    public function findByLogin(string $login): ?User
    {
        $sql = "SELECT id, login, pass, role FROM user WHERE login = :login";

        $stmt = $this->pdo->prepare($sql);
        $stmt->execute(['login' => $login]);

        $row = $stmt->fetch();

        if ($row === false) {
            return null;
        }

        return new User(
            (int) $row['id'],
            (string) $row['login'],
            (string) $row['pass'],
            (string) $row['role']
        );
    }
}
```

---

## 4. Service d‚Äôauthentification bas√© sur `$_SESSION`

On va centraliser la logique auth dans un service statique simple.

Cr√©er le fichier **src/Core/AuthService.php** :

```php
<?php
namespace App\Core;

use App\Model\UserRepository;
use App.Model\User;

/**
 * AuthService
 *
 * R√¥le :
 *  - G√©rer la connexion/d√©connexion des utilisateurs.
 *  - Fournir des helpers pour savoir qui est connect√© et avec quel r√¥le.
 *
 * NOTE : d√©mo p√©dagogique, pas pour la production.
 */
class AuthService
{
    /**
     * Tente de connecter un utilisateur.
     * Retourne true si succ√®s, false sinon.
     */
    public static function login(string $login, string $password): bool
    {
        $repo = new UserRepository();
        $user = $repo->findByLogin($login);

        if ($user === null) {
            return false;
        }

        // D√©mo : mot de passe en clair.
        // Pour la production, on utiliserait password_verify().
        if ($user->pass !== $password) {
            return false;
        }

        // Connexion r√©ussie : on stocke les infos minimales en session.
        $_SESSION['user_id']    = $user->id;
        $_SESSION['user_login'] = $user->login;
        $_SESSION['user_role']  = $user->role;

        return true;
    }

    /**
     * D√©connecte l'utilisateur courant.
     */
    public static function logout(): void
    {
        // On vide les variables de session.
        $_SESSION = [];

        // On d√©truit vraiment la session.
        if (session_status() === PHP_SESSION_ACTIVE) {
            session_destroy();
        }
    }

    /**
     * Indique si un utilisateur est connect√©.
     */
    public static function isAuthenticated(): bool
    {
        return isset($_SESSION['user_id']);
    }

    /**
     * Retourne le login de l'utilisateur connect√©, ou null.
     */
    public static function getLogin(): ?string
    {
        return $_SESSION['user_login'] ?? null;
    }

    /**
     * Retourne le r√¥le de l'utilisateur connect√©, ou null.
     */
    public static function getRole(): ?string
    {
        return $_SESSION['user_role'] ?? null;
    }

    /**
     * V√©rifie si l'utilisateur a un r√¥le sp√©cifique.
     */
    public static function hasRole(string $role): bool
    {
        return self::getRole() === $role;
    }
}
```

---

## 5. AuthController : login, traitement, logout

Cr√©er le fichier **src/Controller/AuthController.php** :

```php
<?php
namespace App\Controller;

use App\Core\AuthService;

/**
 * AuthController
 *
 * R√¥le :
 *  - Afficher le formulaire de login.
 *  - Traiter la soumission du formulaire.
 *  - G√©rer la d√©connexion.
 */
class AuthController
{
    /**
     * Affiche le formulaire de connexion.
     * Route : auth/login-form
     */
    public function loginForm(): void
    {
        // On peut √©ventuellement passer un message d'erreur via $_GET ou variable.
        $errorMessage = $_GET['error'] ?? null;

        require dirname(__DIR__, 2) . '/views/auth/login.php';
    }

    /**
     * Traite le formulaire de connexion (POST).
     * Route : auth/login
     */
    public function login(): void
    {
        $login    = trim($_POST['login'] ?? '');
        $password = trim($_POST['pass'] ?? '');

        if ($login === '' || $password === '') {
            // Simple gestion d'erreur : on repasse par login-form avec un message.
            $errorMessage = "Login et mot de passe sont obligatoires.";
            require dirname(__DIR__, 2) . '/views/auth/login.php';
            return;
        }

        $ok = AuthService::login($login, $password);

        if (!$ok) {
            $errorMessage = "Identifiants invalides.";
            require dirname(__DIR__, 2) . '/views/auth/login.php';
            return;
        }

        // Connexion OK : on redirige vers la liste des produits.
        header('Location: index.php?r=produit/index');
        exit;
    }

    /**
     * D√©connecte l'utilisateur.
     * Route : auth/logout
     */
    public function logout(): void
    {
        AuthService::logout();

        // Apr√®s logout, on renvoie vers la page de login.
        header('Location: index.php?r=auth/login-form');
        exit;
    }
}
```

---

## 6. Vue de login

Cr√©er le fichier **views/auth/login.php** (cr√©e le dossier `auth` si besoin) :

```php
<?php
// views/auth/login.php
//
// Formulaire de connexion simple.
// Variables possibles : $errorMessage (string|null)

$title = 'Connexion';

ob_start();
?>
<h2>Connexion</h2>

<?php if (!empty($errorMessage)): ?>
    <p style="color: red;"><?= htmlspecialchars($errorMessage) ?></p>
<?php endif; ?>

<form method="post" action="index.php?r=auth/login">
    <div>
        <label for="login">Login :</label><br>
        <input type="text" name="login" id="login" required>
    </div>
    <div>
        <label for="pass">Mot de passe :</label><br>
        <input type="password" name="pass" id="pass" required>
    </div>
    <div style="margin-top: 1rem;">
        <button type="submit">Se connecter</button>
    </div>
</form>
<?php
$content = ob_get_clean();
require __DIR__ . '/../layout.php';
```

---

## 7. Adapter le layout pour afficher l‚Äôinfo utilisateur

On va enrichir `views/layout.php` pour :

- afficher qui est connect√©,

- montrer des liens Login / Logout,

- afficher le lien ‚ÄúNouveau produit‚Äù uniquement aux admins.

Modifier le fichier **views/layout.php** (ajout des `use` + bandeau user) :

```php
<?php
// views/layout.php

use App\Core\AuthService;
?>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title><?= htmlspecialchars($title ?? 'Mini MVC Produits') ?></title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        header { margin-bottom: 1.5rem; }
        nav a { margin-right: 1rem; }
        table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
        th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
        .error { color: red; font-weight: bold; }
        form div { margin-bottom: 0.5rem; }
        .user-info { float: right; }
    </style>
</head>
<body>
    <header>
        <h1>Mini MVC Produits</h1>

        <div class="user-info">
            <?php if (AuthService::isAuthenticated()): ?>
                Connect√© en tant que
                <strong><?= htmlspecialchars(AuthService::getLogin()) ?></strong>
                (r√¥le : <?= htmlspecialchars(AuthService::getRole() ?? '') ?>)
                |
                <a href="index.php?r=auth/logout">Se d√©connecter</a>
            <?php else: ?>
                <a href="index.php?r=auth/login-form">Se connecter</a>
            <?php endif; ?>
        </div>

        <nav>
            <a href="index.php?r=produit/index">Liste des produits</a>

            <?php if (AuthService::isAuthenticated() && AuthService::hasRole('admin')): ?>
                <a href="index.php?r=produit/nouveau">Nouveau produit</a>
            <?php endif; ?>
        </nav>
        <div style="clear: both;"></div>
        <hr>
    </header>

    <main>
        <?= $content ?? '' ?>
    </main>
</body>
</html>
```

---

## 8. Prot√©ger les actions ‚Äúsensibles‚Äù dans `ProduitController`

On veut que :

- **tout le monde** puisse voir la liste et le d√©tail,

- **seuls les admins** puissent cr√©er / ajouter / supprimer.

Modifier le fichier **src/Controller/ProduitController.php** pour ajouter l‚Äôusage d‚Äô`AuthService` et les gardes :

```php
<?php
namespace App\Controller;

use App.Model\ProduitRepository;
use App.Core\AuthService;

/**
 * ProduitController
 */
class ProduitController
{
    private ProduitRepository $repository;

    public function __construct()
    {
        $this->repository = new ProduitRepository();
    }

    public function index(): void
    {
        $produits = $this->repository->findAll();
        require dirname(__DIR__, 2) . '/views/produit/liste.php';
    }

    public function show(): void
    {
        $id = isset($_GET['id']) ? (int) $_GET['id'] : 0;

        if ($id <= 0) {
            $messageErreur = "Identifiant de produit invalide.";
            require dirname(__DIR__, 2) . '/views/erreur.php';
            return;
        }

        $produit = $this->repository->find($id);

        if ($produit === null) {
            $messageErreur = "Produit introuvable (id = {$id}).";
            require dirname(__DIR__, 2) . '/views/erreur.php';
            return;
        }

        require dirname(__DIR__, 2) . '/views/produit/detail.php';
    }

    /**
     * Formulaire de cr√©ation (r√©serv√© aux admins).
     */
    public function nouveau(): void
    {
        if (!AuthService::isAuthenticated() || !AuthService::hasRole('admin')) {
            $messageErreur = "Acc√®s refus√© : cette action est r√©serv√©e aux administrateurs.";
            require dirname(__DIR__, 2) . '/views/erreur.php';
            return;
        }

        require dirname(__DIR__, 2) . '/views/produit/nouveau.php';
    }

    /**
     * Traitement POST de cr√©ation (r√©serv√© aux admins).
     */
    public function ajouter(): void
    {
        if (!AuthService::isAuthenticated() || !AuthService::hasRole('admin')) {
            $messageErreur = "Acc√®s refus√© : cette action est r√©serv√©e aux administrateurs.";
            require dirname(__DIR__, 2) . '/views/erreur.php';
            return;
        }

        $nom             = trim($_POST['nom'] ?? '');
        $dateFabrication = trim($_POST['dateFabrication'] ?? '');

        if ($nom === '' || $dateFabrication === '') {
            $messageErreur = "Le nom et la date de fabrication sont obligatoires.";
            require dirname(__DIR__, 2) . '/views/erreur.php';
            return;
        }

        $this->repository->add($nom, $dateFabrication);

        header('Location: index.php?r=produit/index');
        exit;
    }

    /**
     * Suppression (r√©serv√©e aux admins).
     */
    public function supprimer(): void
    {
        if (!AuthService::isAuthenticated() || !AuthService::hasRole('admin')) {
            $messageErreur = "Acc√®s refus√© : cette action est r√©serv√©e aux administrateurs.";
            require dirname(__DIR__, 2) . '/views/erreur.php';
            return;
        }

        $id = isset($_GET['id']) ? (int) $_GET['id'] : 0;

        if ($id <= 0) {
            $messageErreur = "Identifiant de produit invalide pour la suppression.";
            require dirname(__DIR__, 2) . '/views/erreur.php';
            return;
        }

        $ok = $this->repository->delete($id);

        if (!$ok) {
            $messageErreur = "Aucun produit trouv√© √† supprimer (id = {$id}).";
            require dirname(__DIR__, 2) . '/views/erreur.php';
            return;
        }

        header('Location: index.php?r=produit/index');
        exit;
    }
}
```

---

## 9. Mettre √† jour le router (front controller)

Enfin, on d√©clare les routes d‚Äôauthentification et on s‚Äôassure que la session est d√©marr√©e.

Modifier le fichier **public/index.php** :

```php
<?php
// public/index.php

// 1) Toujours d√©marrer la session AVANT tout output.
session_start();

require_once __DIR__ . '/../vendor/autoload.php';

use App\Core\Router;
use App\Controller\ProduitController;
use App\Controller\AuthController;

// Router
$router = new Router();

// Routes produits
$router->add('produit/index',     ProduitController::class, 'index');
$router->add('produit/show',      ProduitController::class, 'show');
$router->add('produit/nouveau',   ProduitController::class, 'nouveau');
$router->add('produit/ajouter',   ProduitController::class, 'ajouter');
$router->add('produit/supprimer', ProduitController::class, 'supprimer');

// Routes auth
$router->add('auth/login-form', AuthController::class, 'loginForm');
$router->add('auth/login',      AuthController::class, 'login');
$router->add('auth/logout',     AuthController::class, 'logout');

// ... le reste du code (r√©solution de la route + appel du contr√¥leur) reste identique
$routeName   = $_GET['r'] ?? $router->getDefaultRouteName();
$routeConfig = $router->match($routeName);

if ($routeConfig === null) {
    http_response_code(404);
    $messageErreur = "Route introuvable : " . htmlspecialchars($routeName);
    require __DIR__ . '/../views/erreur.php';
    exit;
}

$controllerClass = $routeConfig['controller'];
$actionName      = $routeConfig['action'];

if (!class_exists($controllerClass)) {
    http_response_code(500);
    $messageErreur = "Contr√¥leur introuvable : " . htmlspecialchars($controllerClass);
    require __DIR__ . '/../views/erreur.php';
    exit;
}

$controller = new $controllerClass();

if (!method_exists($controller, $actionName)) {
    http_response_code(500);
    $messageErreur = "Action introuvable : "
                   . htmlspecialchars($actionName)
                   . " sur le contr√¥leur "
                   . htmlspecialchars($controllerClass);
    require __DIR__ . '/../views/erreur.php';
    exit;
}

$controller->$actionName();
```

---

## 10. Sc√©nario de test p√©dagogique

1. Aller sur `index.php?r=auth/login-form`
   
   - se connecter avec :
     
     - `admin` / `admin123` ‚Üí voit ‚ÄúNouveau produit‚Äù + peut supprimer
     
     - `user` / `user123` ‚Üí ne voit pas ‚ÄúNouveau produit‚Äù + ne peut pas supprimer

2. Tester les actions prot√©g√©es :
   
   - sans √™tre connect√© ‚Üí message ‚ÄúAcc√®s refus√©‚Äù
   
   - connect√© en `user` ‚Üí m√™me chose
   
   - connect√© en `admin` ‚Üí √ßa passe

Tu as maintenant :

- un **router objet**,

- un **MVC avec PDO**,

- une **auth simplifi√©e avec r√¥les**,

- des contr√¥leurs prot√©g√©s en fonction du r√¥le.

# 

## Phase 5: Integrer monolog dans le projet

 On va brancher **Monolog** proprement dans le mini MVC, mais en restant **ultra simple** : juste de quoi logger quelques √©v√©nements (login, ajout/suppression produits) pour la d√©mo.

Je te propose 3 mini √©tapes :

1. Installer Monolog avec Composer

2. Cr√©er une petite fabrique de logger (`LoggerFactory`)

3. Utiliser le logger √† 2‚Äì3 endroits strat√©giques (Auth + Produits)

---

## 1. Installer Monolog avec Composer

Dans la **racine du projet** (`C:\www\mvc2`), ex√©cute :

```bash
composer require monolog/monolog
```

Composer va :

- t√©l√©charger Monolog dans `vendor/`,

- mettre √† jour `composer.json` et `composer.lock`,

- et l‚Äôautoload le prendra automatiquement en charge (via `vendor/autoload.php` que tu utilises d√©j√† dans `public/index.php`).

Rien d‚Äôautre √† faire c√¥t√© Composer.

---

## 2. Cr√©er un logger centralis√© (LoggerFactory)

On va cr√©er une petite classe **App\Core\LoggerFactory** qui fournit **un seul logger** r√©utilisable partout.

- Le logger √©crira dans : `logs/app.log`

- On choisit un niveau simple : `DEBUG` (pour tout voir en d√©mo).

Cr√©e d‚Äôabord le dossier `logs` √† la racine de ton projet (sous Windows tu peux le faire via l‚Äôexplorateur ou VS Code).

Ensuite, cr√©er le fichier **src/Core/LoggerFactory.php** :

```php
<?php
namespace App\Core;

// On importe les classes Monolog n√©cessaires.
use Monolog\Logger;
use Monolog\Handler\StreamHandler;

/**
 * LoggerFactory
 *
 * R√¥le :
 *  - Fournir une instance unique (singleton simple) de Logger Monolog
 *    pour toute l'application.
 *  - Centraliser la configuration (fichier de log, niveau, etc.).
 */
class LoggerFactory
{
    /**
     * @var Logger|null Instance unique de Logger pour l'application.
     */
    private static ?Logger $logger = null;

    /**
     * Retourne l'instance unique de Logger.
     *
     * √Ä la premi√®re utilisation, on cr√©e le Logger et on le configure.
     * Aux appels suivants, on renvoie simplement l'instance d√©j√† cr√©√©e.
     */
    public static function getLogger(): Logger
    {
        if (self::$logger === null) {
            // Nom du canal (channel) logique pour tes logs.
            // Tu peux le retrouver dans chaque ligne de log.
            $logger = new Logger('app');

            // Chemin vers le fichier de log, √† la racine du projet.
            // dirname(__DIR__, 2) = remonte de src/Core -> src -> projet
            $logFile = dirname(__DIR__, 2) . '/logs/app.log';

            // On ajoute un handler qui √©crit dans app.log au niveau DEBUG.
            // DEBUG = on logge tout (info, warning, error...) pour la d√©mo.
            $handler = new StreamHandler($logFile, Logger::DEBUG);
            $logger->pushHandler($handler);

            self::$logger = $logger;
        }

        return self::$logger;
    }
}
```

> Id√©e p√©dagogique :  
> tu pourras montrer que **toutes les parties de l‚Äôappli** appellent `LoggerFactory::getLogger()` et que **tout atterrit dans le m√™me fichier log**.

---

## 3. Utiliser Monolog dans AuthService (login/logout)

On va logger :

- les tentatives de login r√©ussies,

- les tentatives de login √©chou√©es,

- les d√©connexions.

Modifier le fichier **src/Core/AuthService.php** pour y ajouter le logger :

```php
<?php
namespace App\Core;

use App\Model\UserRepository;
use App.Model\User;
use App.Core\LoggerFactory;

/**
 * AuthService
 *
 * R√¥le :
 *  - G√©rer la connexion/d√©connexion des utilisateurs.
 *  - Fournir des helpers pour savoir qui est connect√© et avec quel r√¥le.
 *
 * NOTE : d√©mo p√©dagogique, pas pour la production.
 */
class AuthService
{
    /**
     * Tente de connecter un utilisateur.
     * Retourne true si succ√®s, false sinon.
     */
    public static function login(string $login, string $password): bool
    {
        $repo   = new UserRepository();
        $user   = $repo->findByLogin($login);
        $logger = LoggerFactory::getLogger();

        if ($user === null) {
            // On logge une tentative de login avec un login inconnu.
            $logger->warning('Tentative de login avec login inconnu', [
                'login' => $login,
            ]);
            return false;
        }

        // D√©mo : mot de passe en clair. En prod : password_verify().
        if ($user->pass !== $password) {
            // On logge un √©chec de mot de passe.
            $logger->warning('√âchec de login : mot de passe incorrect', [
                'login' => $login,
                'user_id' => $user->id,
            ]);
            return false;
        }

        // Connexion r√©ussie.
        $_SESSION['user_id']    = $user->id;
        $_SESSION['user_login'] = $user->login;
        $_SESSION['user_role']  = $user->role;

        // On logge un succ√®s de login.
        $logger->info('Connexion r√©ussie', [
            'user_id' => $user->id,
            'login'   => $user->login,
            'role'    => $user->role,
        ]);

        return true;
    }

    /**
     * D√©connecte l'utilisateur courant.
     */
    public static function logout(): void
    {
        $logger = LoggerFactory::getLogger();

        if (isset($_SESSION['user_login'])) {
            // On logge avant de vider la session.
            $logger->info('D√©connexion utilisateur', [
                'user_id' => $_SESSION['user_id'] ?? null,
                'login'   => $_SESSION['user_login'] ?? null,
                'role'    => $_SESSION['user_role'] ?? null,
            ]);
        }

        $_SESSION = [];

        if (session_status() === PHP_SESSION_ACTIVE) {
            session_destroy();
        }
    }

    public static function isAuthenticated(): bool
    {
        return isset($_SESSION['user_id']);
    }

    public static function getLogin(): ?string
    {
        return $_SESSION['user_login'] ?? null;
    }

    public static function getRole(): ?string
    {
        return $_SESSION['user_role'] ?? null;
    }

    public static function hasRole(string $role): bool
    {
        return self::getRole() === $role;
    }
}
```

---

## 4. Utiliser Monolog dans ProduitRepository (add / delete)

On peut aussi logguer les op√©rations **d‚Äô√©criture** :

- quand un produit est cr√©√©,

- quand un produit est supprim√© (ou que la suppression √©choue).

Modifier le fichier **src/Model/ProduitRepository.php** :

```php
<?php
namespace App.Model;

use App.Core\Database;
use App.Core.LoggerFactory;
use App.Model\Produit;
use PDO;

/**
 * ProduitRepository (version PDO + MySQL)
 */
class ProduitRepository
{
    private PDO $pdo;

    public function __construct()
    {
        $this->pdo = Database::getConnection();
    }

    /**
     * @return Produit[]
     */
    public function findAll(): array
    {
        $sql   = "SELECT id, nom, datefabrication FROM produit";
        $stmt  = $this->pdo->query($sql);
        $produits = [];

        while ($row = $stmt->fetch()) {
            $produits[] = new Produit(
                (int) $row['id'],
                (string) $row['nom'],
                (string) $row['datefabrication']
            );
        }

        return $produits;
    }

    public function find(int $id): ?Produit
    {
        $sql  = "SELECT id, nom, datefabrication FROM produit WHERE id = :id";
        $stmt = $this->pdo->prepare($sql);
        $stmt->execute(['id' => $id]);

        $row = $stmt->fetch();

        if ($row === false) {
            return null;
        }

        return new Produit(
            (int) $row['id'],
            (string) $row['nom'],
            (string) $row['datefabrication']
        );
    }

    public function add(string $nom, string $dateFabrication): Produit
    {
        $sql = "INSERT INTO produit (nom, datefabrication)
                VALUES (:nom, :datefabrication)";

        $stmt = $this->pdo->prepare($sql);
        $stmt->execute([
            'nom'             => $nom,
            'datefabrication' => $dateFabrication,
        ]);

        $id = (int) $this->pdo->lastInsertId();

        $produit = new Produit($id, $nom, $dateFabrication);

        // On logge la cr√©ation du produit
        $logger = LoggerFactory::getLogger();
        $logger->info('Produit cr√©√©', [
            'id'              => $id,
            'nom'             => $nom,
            'dateFabrication' => $dateFabrication,
        ]);

        return $produit;
    }

    public function delete(int $id): bool
    {
        $sql  = "DELETE FROM produit WHERE id = :id";
        $stmt = $this->pdo->prepare($sql);
        $stmt->execute(['id' => $id]);

        $deleted = $stmt->rowCount() > 0;

        $logger = LoggerFactory::getLogger();

        if ($deleted) {
            $logger->info('Produit supprim√©', [
                'id' => $id,
            ]);
        } else {
            $logger->warning('Tentative de suppression d\'un produit inexistant', [
                'id' => $id,
            ]);
        }

        return $deleted;
    }
}
```

---

## 5. Test de la d√©mo Monolog

1. V√©rifier que l‚Äôextension `pdo_mysql` fonctionne d√©j√† (c‚Äôest le cas si ton appli tourne).

2. V√©rifier que le dossier `logs` existe √† la racine du projet.

3. Lancer ton appli comme d‚Äôhabitude (`php -S localhost:8000 -t public` ou Apache/MAMP).

4. Sc√©nario de test :
   
   - Aller sur la page de login : `index.php?r=auth/login-form`
   
   - Tenter un login **invalide** (mauvais login) ‚Üí check `logs/app.log`
   
   - Tenter un login avec **mauvais mot de passe** ‚Üí check `logs/app.log`
   
   - Login avec `admin / admin123` ‚Üí `logs/app.log` doit montrer `Connexion r√©ussie`
   
   - Cr√©er un nouveau produit ‚Üí log `Produit cr√©√©`
   
   - Supprimer un produit ‚Üí log `Produit supprim√©`
   
   - Cliquer sur ‚ÄúSe d√©connecter‚Äù ‚Üí log `D√©connexion utilisateur`

Ouvre `logs/app.log` dans VS Code, tu devrais voir des lignes du style :

```text
[2025-11-13T21:10:25.123456+01:00] app.INFO: Connexion r√©ussie {"user_id":1,"login":"admin","role":"admin"}
[2025-11-13T21:12:40.654321+01:00] app.INFO: Produit cr√©√© {"id":4,"nom":"Clavier m√©canique","dateFabrication":"2024-01-15"}
```

---

Avec √ßa, tu as une **int√©gration Monolog minimale mais r√©aliste** :

- installation via Composer,

- centralisation via `LoggerFactory`,

- logs sur les points critiques (auth + CRUD produits),

- z√©ro changement dans le router, juste utilisation de `vendor/autoload.php` comme avant.
