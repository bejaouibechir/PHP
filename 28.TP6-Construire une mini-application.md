# üéì TP6 (√©tendu) ‚Äî Mini-application OO + Persistance JSON

## üéØ Objectifs

- Ajouter une **persistance simple** (fichier `data/users.json`) pour **enregistrer** et **lister** les utilisateurs (Admin, Membre, Visiteur).

- Illustrer **interfaces + classes abstraites + polymorphisme** dans un **cas concret**.

- Utiliser **Composer** (autoload PSR-4) comme dans un vrai projet.

---

## üß≠ Architecture (vue d‚Äôensemble)

- `Utilisateur` (abstraite) + `Admin` / `Membre` / `Visiteur` (h√©ritage).

- `Authentifiable` (interface) : impose `seConnecter()` / `seDeconnecter()`.

- `SessionManager` (service statique) : d√©marrage et gestion session.

- **Nouveaux** :
  
  - `UserRecord` (objet de donn√©es simple ‚Äî s√©rialisable JSON),
  
  - `UserRepository` (interface),
  
  - `FileUserRepository` (impl√©mentation JSON),
  
  - `App` (orchestration, ‚Äúroutes‚Äù minimales via `action=list|add|reset`).

Arborescence cible :

```
tp6-app/
‚îú‚îÄ‚îÄ composer.json
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îî‚îÄ‚îÄ users.json               (sera cr√©√© automatiquement)
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îî‚îÄ‚îÄ index.php
‚îî‚îÄ‚îÄ src/
    ‚îú‚îÄ‚îÄ App.php
    ‚îú‚îÄ‚îÄ Core/
    ‚îÇ   ‚îú‚îÄ‚îÄ Admin.php
    ‚îÇ   ‚îú‚îÄ‚îÄ Membre.php
    ‚îÇ   ‚îú‚îÄ‚îÄ Utilisateur.php
    ‚îÇ   ‚îî‚îÄ‚îÄ Visiteur.php
    ‚îú‚îÄ‚îÄ Domain/
    ‚îÇ   ‚îî‚îÄ‚îÄ UserRecord.php
    ‚îú‚îÄ‚îÄ Interfaces/
    ‚îÇ   ‚îú‚îÄ‚îÄ Authentifiable.php
    ‚îÇ   ‚îî‚îÄ‚îÄ UserRepository.php
    ‚îú‚îÄ‚îÄ Repositories/
    ‚îÇ   ‚îî‚îÄ‚îÄ FileUserRepository.php
    ‚îî‚îÄ‚îÄ Services/
        ‚îî‚îÄ‚îÄ SessionManager.php
```

> ‚ö†Ô∏è **Composer** doit d√©j√† √™tre initialis√© avec l‚Äôautoload PSR-4 (`"App\\": "src/"`).  
> Si ce n‚Äôest pas le cas : mettez √† jour `composer.json` et lancez `composer dump-autoload`.

---

## üß± 1) Mod√®le de donn√©es persistant

Cr√©er le fichier **src/Domain/UserRecord.php** :

```php
<?php
namespace App\Domain;

/**
 * Repr√©sente une version "persistable" d'un utilisateur,
 * ind√©pendante des d√©tails d'impl√©mentation des classes OO (Admin/Membre/Visiteur).
 * On stocke ce qui est n√©cessaire pour reconstruire l'utilisateur.
 */
class UserRecord
{
    public function __construct(
        public string $nom,
        public string $role,   // "Administrateur" | "Membre" | "Visiteur"
        public string $type    // "admin" | "membre" | "visiteur"
    ) {}

    /** Retourne un tableau s√©rialisable en JSON */
    public function toArray(): array
    {
        return [
            'nom'  => $this->nom,
            'role' => $this->role,
            'type' => $this->type,
        ];
    }

    /** Fabrique un UserRecord depuis un tableau JSON */
    public static function fromArray(array $data): self
    {
        return new self(
            nom:  (string)($data['nom'] ?? 'Inconnu'),
            role: (string)($data['role'] ?? 'Visiteur'),
            type: (string)($data['type'] ?? 'visiteur')
        );
    }
}
```

---

## üß© 2) Contrat de persistance (interface)

Cr√©er le fichier **src/Interfaces/UserRepository.php** :

```php
<?php
namespace App\Interfaces;

use App\Domain\UserRecord;

/**
 * Contrat de persistance pour UserRecord.
 * Permet d'√©changer d'impl√©mentation (fichier JSON, base SQL, API...) sans toucher au reste du code.
 */
interface UserRepository
{
    /** Enregistre un utilisateur (append) */
    public function add(UserRecord $user): void;

    /** Retourne la liste compl√®te des utilisateurs */
    public function all(): array;

    /** Supprime toutes les entr√©es (reset) */
    public function clear(): void;
}
```

---

## üíæ 3) Impl√©mentation JSON (fichier)

Cr√©er le fichier **src/Repositories/FileUserRepository.php** :

```php
<?php
namespace App\Repositories;

use App\Domain\UserRecord;
use App\Interfaces\UserRepository;

/**
 * Impl√©mentation de UserRepository stock√©e en JSON sur disque.
 * - Fichier: data/users.json
 * - Ecriture atomique: file_put_contents(..., LOCK_EX)
 * - JSON lisible: JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE
 */
class FileUserRepository implements UserRepository
{
    private string $filePath;

    public function __construct(string $filePath = __DIR__ . '/../../data/users.json')
    {
        $this->filePath = $filePath;
        $this->ensureStorage();
    }

    /** Ajoute un UserRecord √† la fin de la liste */
    public function add(UserRecord $user): void
    {
        $all = $this->readAll();
        $all[] = $user->toArray();
        $this->writeAll($all);
    }

    /** Retourne tous les UserRecord */
    public function all(): array
    {
        $rows = $this->readAll();
        return array_map(fn($row) => UserRecord::fromArray($row), $rows);
    }

    /** Vide le fichier (r√©initialisation) */
    public function clear(): void
    {
        $this->writeAll([]);
    }

    // ----------------- helpers internes -----------------

    private function ensureStorage(): void
    {
        $dir = \dirname($this->filePath);
        if (!is_dir($dir)) {
            mkdir($dir, 0777, true);
        }
        if (!file_exists($this->filePath)) {
            $this->writeAll([]);
        }
    }

    private function readAll(): array
    {
        $json = @file_get_contents($this->filePath);
        if ($json === false || $json === '') {
            return [];
        }
        $data = json_decode($json, true);
        return is_array($data) ? $data : [];
    }

    private function writeAll(array $rows): void
    {
        $json = json_encode($rows, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);
        file_put_contents($this->filePath, $json . PHP_EOL, LOCK_EX);
    }
}
```

---

## üë§ 4) Rappel des entit√©s OO (d√©j√† vues dans TP6 de base)

> Si vos fichiers existent d√©j√†, **ne les recr√©ez pas** ‚Äî gardez-les.  
> Sinon, cr√©ez/compl√©tez-les comme suit.

Cr√©er le fichier **src/Interfaces/Authentifiable.php** :

```php
<?php
namespace App\Interfaces;

/** Contrat d'authentification basique */
interface Authentifiable
{
    public function seConnecter(): string;
    public function seDeconnecter(): string;
}
```

Cr√©er le fichier **src/Core/Utilisateur.php** :

```php
<?php
namespace App\Core;

use App\Interfaces\Authentifiable;

/**
 * Classe abstraite: mod√®le de base pour tout utilisateur.
 * - Encapsulation: propri√©t√©s prot√©g√©es.
 * - Abstraction: m√©thode afficherDashboard() impos√©e aux enfants.
 */
abstract class Utilisateur implements Authentifiable
{
    protected string $nom;
    protected string $role;

    public function __construct(string $nom, string $role)
    {
        $this->nom  = $nom;
        $this->role = $role;
    }

    public function getNom(): string    { return $this->nom; }
    public function getRole(): string   { return $this->role; }

    abstract public function afficherDashboard(): string;

    public function seConnecter(): string   { return "{$this->nom} est connect√© en tant que {$this->role}."; }
    public function seDeconnecter(): string { return "{$this->nom} s‚Äôest d√©connect√©."; }
}
```

Cr√©er le fichier **src/Core/Admin.php** :

```php
<?php
namespace App\Core;

/** Sp√©cialisation Administrateur (h√©ritage) */
class Admin extends Utilisateur
{
    public function afficherDashboard(): string
    {
        return "üëë Tableau de bord administrateur : gestion des utilisateurs et des logs.";
    }
}
```

Cr√©er le fichier **src/Core/Membre.php** :

```php
<?php
namespace App\Core;

/** Sp√©cialisation Membre (h√©ritage) */
class Membre extends Utilisateur
{
    public function afficherDashboard(): string
    {
        return "üßë‚Äçüíª Espace membre : vos projets, vos favoris et votre messagerie.";
    }
}
```

Cr√©er le fichier **src/Core/Visiteur.php** :

```php
<?php
namespace App\Core;

/** Sp√©cialisation Visiteur (h√©ritage) */
class Visiteur extends Utilisateur
{
    public function afficherDashboard(): string
    {
        return "üëÄ Bienvenue visiteur : connectez-vous pour acc√©der √† votre espace personnel.";
    }
}
```

Cr√©er le fichier **src/Services/SessionManager.php** :

```php
<?php
namespace App\Services;

/**
 * Service utilitaire statique pour la session.
 * - Pas d'√©tat propre √† un objet => m√©thodes statiques justifi√©es.
 */
class SessionManager
{
    public static function demarrer(): void
    {
        if (session_status() === PHP_SESSION_NONE) {
            session_start();
        }
    }

    public static function set(string $key, mixed $value): void
    {
        $_SESSION[$key] = $value;
    }

    public static function get(string $key): mixed
    {
        return $_SESSION[$key] ?? null;
    }

    public static function detruire(): void
    {
        if (session_status() === PHP_SESSION_ACTIVE) {
            session_destroy();
        }
    }
}
```

---

## üß† 5) Orchestration applicative (+ ‚Äúmicro-routing‚Äù par query string)

Cr√©er le fichier **src/App.php** :

```php
<?php
namespace App;

use App\Core\Admin;
use App\Core\Membre;
use App\Core\Visiteur;
use App\Domain\UserRecord;
use App\Repositories\FileUserRepository;
use App\Services\SessionManager;

/**
 * App centralise le flux:
 * - "Routes" minimales via ?action=list|add|reset
 * - Persistance JSON via FileUserRepository
 * - Cr√©ation d'objets OO et polymorphisme
 */
class App
{
    public function run(): void
    {
        SessionManager::demarrer();

        // Instancie un d√©p√¥t JSON (respecte le contrat UserRepository)
        $repo = new FileUserRepository();

        $action = $_GET['action'] ?? 'list';
        $role   = $_GET['role']   ?? null;      // "admin" | "membre" | "visiteur"
        $nom    = $_GET['nom']    ?? null;

        switch ($action) {
            case 'add':
                $this->handleAdd($repo, $role, $nom);
                break;

            case 'reset':
                $repo->clear();
                $this->renderPage("<h2>R√©initialisation</h2><p>La liste des utilisateurs a √©t√© vid√©e.</p>");
                break;

            case 'list':
            default:
                $this->handleList($repo);
                break;
        }
    }

    // ---------------------- actions ----------------------

    private function handleAdd(FileUserRepository $repo, ?string $role, ?string $nom): void
    {
        // Validation minimale
        $type = strtolower((string)$role);
        $nom  = trim((string)$nom);
        if ($nom === '' || !in_array($type, ['admin', 'membre', 'visiteur'], true)) {
            $this->renderPage("<h2>Ajout invalide</h2><p>Utilisez ?action=add&role=admin|membre|visiteur&nom=Jean</p>");
            return;
        }

        // Fabrique l'objet OO selon le type (polymorphisme)
        $userObj = match ($type) {
            'admin'    => new Admin($nom, 'Administrateur'),
            'membre'   => new Membre($nom, 'Membre'),
            default    => new Visiteur($nom, 'Visiteur'),
        };

        // Enregistre une repr√©sentation persistable
        $repo->add(new UserRecord(nom: $userObj->getNom(), role: $userObj->getRole(), type: $type));

        // Feedback utilisateur
        $html  = "<h2>Ajout</h2>";
        $html .= "<p>" . $userObj->seConnecter() . "</p>";
        $html .= "<p>Dashboard : " . $userObj->afficherDashboard() . "</p>";
        $html .= "<p style='color:green'>‚úÖ Enregistr√© dans data/users.json</p>";
        $html .= "<p><a href='/?action=list'>Voir la liste</a></p>";

        $this->renderPage($html);
    }

    private function handleList(FileUserRepository $repo): void
    {
        $rows = $repo->all();

        $count = count($rows);
        $html  = "<h2>Utilisateurs enregistr√©s ({$count})</h2>";

        if ($count === 0) {
            $html .= "<p>Aucun utilisateur pour l‚Äôinstant.</p>";
        } else {
            $html .= "<table border='1' cellpadding='6' cellspacing='0'>
                        <tr><th>Nom</th><th>R√¥le</th><th>Type</th></tr>";
            foreach ($rows as $r) {
                $html .= "<tr><td>".htmlspecialchars($r->nom)."</td>
                              <td>".htmlspecialchars($r->role)."</td>
                              <td>".htmlspecialchars($r->type)."</td></tr>";
            }
            $html .= "</table>";
        }

        $html .= "<hr>
                  <p><a href='/?action=add&role=admin&nom=Bechir'>Ajouter Admin</a> |
                     <a href='/?action=add&role=membre&nom=Ali'>Ajouter Membre</a> |
                     <a href='/?action=add&role=visiteur&nom=Sam'>Ajouter Visiteur</a></p>
                  <p><a href='/?action=reset' style='color:#b00'>Reset (vider la liste)</a></p>";

        $this->renderPage($html);
    }

    // ---------------------- rendu basique ----------------------

    private function renderPage(string $content, string $title = "TP6 - Persistance JSON"): void
    {
        echo "<!doctype html><html lang='fr'><head><meta charset='utf-8'>
              <meta name='viewport' content='width=device-width, initial-scale=1'>
              <title>".htmlspecialchars($title)."</title>
              <style>
                body{font-family:system-ui,Arial;margin:32px;background:#f6f8fb}
                .card{max-width:900px;margin:auto;background:#fff;padding:24px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
                a{color:#0b63d1;text-decoration:none}
                a:hover{text-decoration:underline}
                table{border-collapse:collapse;background:#fff}
                th{background:#0b63d1;color:#fff}
              </style></head><body><div class='card'>
              <h1>TP6 ‚Äì OO + Persistance JSON</h1>
              {$content}
              </div></body></html>";
    }
}
```

---

## üö™ 6) Point d‚Äôentr√©e public

Cr√©er le fichier **public/index.php** :

```php
<?php
// Point d'entr√©e unique de l'appli (front-controller).
require __DIR__ . '/../vendor/autoload.php';

use App\App;

$app = new App();
$app->run();
```

---

## ‚ñ∂Ô∏è 7) Ex√©cution & v√©rifications

1. Lancer l‚Äôautoload (si vous venez d‚Äôajouter des fichiers) :

```bash
composer dump-autoload
```

2. D√©marrer le serveur web embarqu√© :

```bash
php -S localhost:8000 -t public
```

3. Tester dans le navigateur :
- Liste (par d√©faut) :  
  `http://localhost:8000/`

- Ajout d‚Äôun Admin :  
  `http://localhost:8000/?action=add&role=admin&nom=Bechir`

- Ajout d‚Äôun Membre :  
  `http://localhost:8000/?action=add&role=membre&nom=Ali`

- Ajout d‚Äôun Visiteur :  
  `http://localhost:8000/?action=add&role=visiteur&nom=Sam`

- Reset :  
  `http://localhost:8000/?action=reset`
4. V√©rifier le fichier **data/users.json** : il doit contenir un tableau JSON lisible, avec vos enregistrements.

---

## üß™ R√©sultats attendus

- L‚ÄôURL *list* affiche un tableau HTML des utilisateurs persist√©s.

- L‚ÄôURL *add* cr√©e un objet OO (Admin/Membre/Visiteur), **affiche son dashboard**, puis **l‚Äôenregistre**.

- L‚ÄôURL *reset* vide le fichier JSON.

- **Aucune inclusion manuelle** de classes : tout est charg√© via **Composer**.

---

## üß† Pourquoi c‚Äôest ‚Äúun vrai‚Äù TP (et pas un simple atelier)

- On **utilise** les concepts OO (abstraction, interface, polymorphisme, encapsulation, statique) pour **faire quelque chose de r√©el**.

- On **isole la persistance** derri√®re une **interface** (on pourra remplacer le JSON par SQLite sans changer `App`).

- On **met sous projecteurs Composer** (PSR-4, autoload, structure propre).

- On garde un **micro-routing** minimal pour se concentrer sur l‚Äôexercice central (la persistance).

---

## ‚ö†Ô∏è Pi√®ges & astuces

- **Chemins** : si `data/users.json` n‚Äôappara√Æt pas, v√©rifiez les chemins relatifs dans `FileUserRepository`.

- **Droits d‚Äô√©criture** : sous Linux, donnez la permission au dossier `data/`.

- **Atomicit√©** : `LOCK_EX` dans `file_put_contents` √©vite les corruptions en √©criture.

- **√âvolutivit√©** : on pourrait injecter `UserRepository` via un conteneur DI ; pour ce TP, l‚Äôinstanciation directe est plus lisible.



Parfait ‚Äî on encha√Æne logiquement : **TP6 (suite)** = m√™me application, **mais on remplace la persistance JSON par SQLite (PDO)** sans casser le reste du code, gr√¢ce √† l‚Äôinterface `UserRepository`.  
Objectifs : montrer l‚Äôint√©r√™t **concret** des interfaces, du **polymorphisme** et remettre **Composer/autoload** en lumi√®re dans un cas r√©aliste.

## üéì Passer de JSON √† SQLite via le pattern Repository (PDO)

## üéØ Objectifs

- Impl√©menter une persistance **SQLite** avec **PDO**.

- Respecter l‚Äôinterface `UserRepository` pour un **switch transparent** (JSON ‚áÑ SQLite).

- Introduire une **s√©lection de d√©p√¥t** par configuration (query string/env).

- Conserver l‚ÄôAPI existante (`?action=list|add|reset`).

---

## 0) Pr√©-requis rapides

- **Composer** d√©j√† initialis√© avec autoload PSR-4 (`"App\\": "src/"`) et `vendor/autoload.php`.

- Extension **PDO** et **pdo_sqlite** activ√©es (par d√©faut sur PHP ‚â• 8.x).  
  Si besoin, v√©rifier avec `php -m | findstr sqlite` (Windows cmd) ou `php -m | grep sqlite` (Linux/Mac).

---

## 1) Cr√©er le d√©p√¥t SQLite

Cr√©er le fichier **src/Repositories/SqliteUserRepository.php** :

```php
<?php
namespace App\Repositories;

use App\Domain\UserRecord;
use App\Interfaces\UserRepository;
use PDO;
use PDOException;

/**
 * Persistance SQLite (PDO) pour UserRecord.
 * Fichier DB: data/app.db
 * Table: users(id, nom, role, type, created_at)
 */
class SqliteUserRepository implements UserRepository
{
    private PDO $pdo;

    public function __construct(string $dbPath = __DIR__ . '/../../data/app.db')
    {
        $dsn = 'sqlite:' . $dbPath;

        // Assure l'existence du dossier data/
        $dir = \dirname($dbPath);
        if (!is_dir($dir)) {
            mkdir($dir, 0777, true);
        }

        // Connexion PDO
        $this->pdo = new PDO($dsn, null, null, [
            PDO::ATTR_ERRMODE            => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        ]);

        // Migration minimale
        $this->migrate();
    }

    /** Cr√©e la table si elle n'existe pas */
    private function migrate(): void
    {
        $sql = <<<SQL
        CREATE TABLE IF NOT EXISTS users (
            id         INTEGER PRIMARY KEY AUTOINCREMENT,
            nom        TEXT    NOT NULL,
            role       TEXT    NOT NULL,
            type       TEXT    NOT NULL,
            created_at TEXT    NOT NULL
        );
        SQL;
        $this->pdo->exec($sql);
    }

    /** Ajoute un UserRecord */
    public function add(UserRecord $user): void
    {
        $stmt = $this->pdo->prepare(
            'INSERT INTO users(nom, role, type, created_at) VALUES (:nom, :role, :type, :ts)'
        );
        $stmt->execute([
            ':nom'  => $user->nom,
            ':role' => $user->role,
            ':type' => $user->type,
            ':ts'   => date('c'), // ISO 8601
        ]);
    }

    /** Retourne tous les UserRecord (ordre ant√©chronologique) */
    public function all(): array
    {
        $stmt = $this->pdo->query('SELECT nom, role, type FROM users ORDER BY id DESC');
        $rows = $stmt->fetchAll();

        return array_map(fn(array $r) => UserRecord::fromArray($r), $rows);
    }

    /** Vide la table (reset) */
    public function clear(): void
    {
        $this->pdo->exec('DELETE FROM users');
        // Optionnel: r√©initialiser l'AUTO INCREMENT
        $this->pdo->exec('DELETE FROM sqlite_sequence WHERE name="users"');
    }
}
```

**Pourquoi c‚Äôest pro :**

- **Migration auto** dans le constructeur ‚Üí z√©ro √©tape manuelle pour cr√©er la table.

- **PDO en mode exceptions** ‚Üí erreurs visibles et tra√ßables.

- **S√©rialisation/d√©s√©rialisation** d√©j√† g√©r√©e c√¥t√© `UserRecord`.

---

## 2) Injecter le repository choisi (JSON ou SQLite)

Deux options pragmatiques, **sans conteneur DI** pour rester p√©dagogique :

- via **query string** (`?repo=sqlite` ou `?repo=json`)

- via **variable d‚Äôenvironnement** (`APP_REPO=sqlite|json`) ‚Äî utile en CI/production.

Modifier **src/App.php** pour la s√©lection :

```php
<?php
namespace App;

use App\Core\Admin;
use App\Core\Membre;
use App\Core\Visiteur;
use App\Domain\UserRecord;
use App\Repositories\FileUserRepository;
use App\Repositories\SqliteUserRepository;
use App\Services\SessionManager;

class App
{
    public function run(): void
    {
        SessionManager::demarrer();

        // 1) S√©lection du d√©p√¥t (ordre: query string > env > d√©faut JSON)
        $repoName = $_GET['repo'] ?? getenv('APP_REPO') ?? 'json';
        $repo     = $this->makeRepository($repoName);

        $action = $_GET['action'] ?? 'list';
        $role   = $_GET['role']   ?? null;
        $nom    = $_GET['nom']    ?? null;

        switch ($action) {
            case 'add':
                $this->handleAdd($repo, $role, $nom, $repoName);
                break;
            case 'reset':
                $repo->clear();
                $this->renderPage("<h2>R√©initialisation</h2><p>Le d√©p√¥t <code>{$repoName}</code> est vid√©.</p>", $repoName);
                break;
            case 'list':
            default:
                $this->handleList($repo, $repoName);
                break;
        }
    }

    /** Fabrique le d√©p√¥t concret en respectant l'interface UserRepository */
    private function makeRepository(string $name)
    {
        $name = strtolower(trim($name));
        return match ($name) {
            'sqlite' => new SqliteUserRepository(), // data/app.db
            default  => new FileUserRepository(),   // data/users.json
        };
    }

    // --------- actions (inchang√©es vs JSON, on ajoute juste l'indication du repo)

    private function handleAdd($repo, ?string $role, ?string $nom, string $repoName): void
    {
        $type = strtolower((string)$role);
        $nom  = trim((string)$nom);

        if ($nom === '' || !in_array($type, ['admin', 'membre', 'visiteur'], true)) {
            $this->renderPage(
                "<h2>Ajout invalide</h2><p>Utilisez ?action=add&role=admin|membre|visiteur&nom=Jean</p>",
                $repoName
            );
            return;
        }

        $userObj = match ($type) {
            'admin'  => new Admin($nom, 'Administrateur'),
            'membre' => new Membre($nom, 'Membre'),
            default  => new Visiteur($nom, 'Visiteur'),
        };

        $repo->add(new UserRecord(nom: $userObj->getNom(), role: $userObj->getRole(), type: $type));

        $html  = "<h2>Ajout</h2>";
        $html .= "<p>" . $userObj->seConnecter() . "</p>";
        $html .= "<p>Dashboard : " . $userObj->afficherDashboard() . "</p>";
        $html .= "<p style='color:green'>‚úÖ Enregistr√© dans le d√©p√¥t <strong>{$repoName}</strong></p>";
        $html .= "<p><a href='/?action=list&repo={$repoName}'>Voir la liste</a></p>";

        $this->renderPage($html, $repoName);
    }

    private function handleList($repo, string $repoName): void
    {
        $rows  = $repo->all();
        $count = count($rows);

        $html  = "<h2>Utilisateurs enregistr√©s ({$count}) ‚Äî d√©p√¥t <code>{$repoName}</code></h2>";

        if ($count === 0) {
            $html .= "<p>Aucun utilisateur pour l‚Äôinstant.</p>";
        } else {
            $html .= "<table border='1' cellpadding='6' cellspacing='0'>
                        <tr><th>Nom</th><th>R√¥le</th><th>Type</th></tr>";
            foreach ($rows as $r) {
                $html .= "<tr><td>".htmlspecialchars($r->nom)."</td>
                              <td>".htmlspecialchars($r->role)."</td>
                              <td>".htmlspecialchars($r->type)."</td></tr>";
            }
            $html .= "</table>";
        }

        $html .= "<hr>
                  <p>D√©p√¥t:
                    <a href='/?action=list&repo=json'>JSON</a> |
                    <a href='/?action=list&repo=sqlite'>SQLite</a>
                  </p>
                  <p>
                    <a href='/?action=add&repo={$repoName}&role=admin&nom=Bechir'>Ajouter Admin</a> |
                    <a href='/?action=add&repo={$repoName}&role=membre&nom=Ali'>Ajouter Membre</a> |
                    <a href='/?action=add&repo={$repoName}&role=visiteur&nom=Sam'>Ajouter Visiteur</a>
                  </p>
                  <p><a href='/?action=reset&repo={$repoName}' style='color:#b00'>Reset (vider)</a></p>";

        $this->renderPage($html, $repoName);
    }

    private function renderPage(string $content, string $repoName, string $title = "TP6 - Persistance (JSON/SQLite)"): void
    {
        echo "<!doctype html><html lang='fr'><head><meta charset='utf-8'>
              <meta name='viewport' content='width=device-width, initial-scale=1'>
              <title>".htmlspecialchars($title)."</title>
              <style>
                body{font-family:system-ui,Arial;margin:32px;background:#f6f8fb}
                .card{max-width:980px;margin:auto;background:#fff;padding:24px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
                .repo{font-size:.95rem;color:#0b63d1}
                a{color:#0b63d1;text-decoration:none}
                a:hover{text-decoration:underline}
                table{border-collapse:collapse;background:#fff}
                th{background:#0b63d1;color:#fff}
              </style></head><body><div class='card'>
              <h1>TP6 ‚Äì OO + Repository + Persistance</h1>
              <p class='repo'>D√©p√¥t actif: <strong>".htmlspecialchars($repoName)."</strong></p>
              {$content}
              </div></body></html>";
    }
}
```

**Ce que vous d√©montrez clairement √† vos participants :**

- **L‚Äôinterface** `UserRepository` permet d‚Äô**√©changer d‚Äôimpl√©mentation** sans toucher aux appels (`add()`, `all()`, `clear()`).

- **Polymorphisme** en action c√¥t√© `App` (le code ‚Äúutilisateur‚Äù ne sait pas si c‚Äôest du JSON ou du SQLite).

- **Composer** continue √† charger toutes les classes automatiquement (PSR-4).

---

## 3) Point d‚Äôentr√©e (inchang√©)

V√©rifier **public/index.php** :

```php
<?php
require __DIR__ . '/../vendor/autoload.php';

use App\App;

$app = new App();
$app->run();
```

---

## 4) Ex√©cution & sc√©narios de test

1. Reg√©n√©rer l‚Äôautoload (si nouveaux fichiers) :

```bash
composer dump-autoload
```

2. Lancer le serveur :

```bash
php -S localhost:8000 -t public
```

3. Tester JSON (par d√©faut) :
- Liste : `http://localhost:8000/`

- Ajout : `http://localhost:8000/?action=add&role=admin&nom=Bechir`

- Reset : `http://localhost:8000/?action=reset`
4. Passer √† **SQLite** :
- Liste : `http://localhost:8000/?repo=sqlite`

- Ajout : `http://localhost:8000/?action=add&repo=sqlite&role=membre&nom=Ali`

- Reset : `http://localhost:8000/?action=reset&repo=sqlite`
5. **V√©rifications** :
- Fichier JSON : `data/users.json` (si repo=json).

- Base SQLite : `data/app.db` (si repo=sqlite).

- La **m√™me UI** fonctionne avec l‚Äôun ou l‚Äôautre d√©p√¥t.

> Option prod : exporter `APP_REPO=sqlite` dans l‚Äôenvironnement pour activer SQLite sans query string.

---

## 5) Pi√®ges & solutions

| Probl√®me                | Cause probable                        | Solution                                                   |
| ----------------------- | ------------------------------------- | ---------------------------------------------------------- |
| ‚Äúcould not find driver‚Äù | `pdo_sqlite` non charg√©               | Activer l‚Äôextension dans `php.ini` puis red√©marrer         |
| `data/app.db` absent    | Dossier `data/` inexistant            | Le constructeur cr√©e le dossier, sinon v√©rifier les droits |
| 500 sur INSERT          | Permissions sur `data/` insuffisantes | Donner les droits d‚Äô√©criture au processus PHP              |
| Tableau vide en list    | Vous regardez l‚Äôautre d√©p√¥t           | V√©rifier `repo=json                                        |

---

## 6) Pourquoi cette suite est ‚Äúformatrice‚Äù (et pas une d√©mo de code)

- Vous **encha√Ænez** logiquement apr√®s *12. La OOP* : **interfaces**, **abstractions**, **polymorphisme**, **statique** ‚Äî mais **au service d‚Äôun cas r√©el**.

- Vous prouvez **l‚Äôint√©r√™t concret** de Composer (autoload PSR-4) dans une archi modulaire.

- Vous **montrez** la valeur du **Repository Pattern** : *changer de stockage sans changer l‚Äôapplication*.

---

## 7) Prochaines extensions (si vous voulez aller encore plus loin)

- Ajouter `removeByName()` et un bouton ‚ÄúSupprimer‚Äù par ligne.

- Introduire un **layout** commun et un **CSS externe** (s√©paration vue/logique).

- Remplacer `match` + `new` par une **factory** (`UserFactory`) pour cr√©er `Admin/Membre/Visiteur`.

- Passer de query string √† un **Router objet** (quand vos participants seront pr√™ts).
